<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Juego de Inversi√≥n</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-color: #38bdf8;
            --success-color: #4ade80;
            --danger-color: #f87171;
            --font-main: 'Outfit', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        #app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--card-bg);
            margin-bottom: 20px;
        }

        h1 {
            font-weight: 600;
            color: var(--accent-color);
        }

        #game-info span {
            margin-left: 20px;
            font-size: 1.1rem;
            font-weight: 400;
        }

        #main-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .nav-btn {
            background-color: var(--card-bg);
            border: 1px solid transparent;
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-main);
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background-color: #334155;
            color: var(--text-primary);
        }

        .nav-btn.active {
            background-color: var(--accent-color);
            color: #0f172a;
            font-weight: 600;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        #next-turn-btn {
            margin-top: 30px;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--accent-color), #0ea5e9);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s;
        }

        #next-turn-btn:hover {
            transform: scale(1.02);
        }

        #next-turn-btn:active {
            transform: scale(0.98);
        }

        /* Market Styles */
        .market-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .market-container {
                grid-template-columns: 1fr;
            }
        }

        .stocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stock-card {
            background-color: var(--card-bg);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .stock-card:hover {
            border-color: var(--accent-color);
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .stock-symbol {
            font-weight: 600;
            color: var(--text-primary);
        }

        .stock-price {
            color: var(--text-secondary);
        }

        .stock-name {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .stock-trend {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .trend-up {
            color: var(--success-color);
        }

        .trend-down {
            color: var(--danger-color);
        }

        /* Portfolio & Trade Panel */
        .portfolio-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #portfolio-list {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
        }

        .portfolio-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #334155;
            font-size: 0.9rem;
        }

        .portfolio-item:last-child {
            border-bottom: none;
        }

        .trade-panel {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
        }

        .trade-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        select,
        input {
            padding: 10px;
            background-color: var(--bg-color);
            border: 1px solid #334155;
            color: var(--text-primary);
            border-radius: 5px;
        }

        .trade-actions {
            display: flex;
            gap: 10px;
        }

        .trade-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-success {
            background-color: var(--success-color);
            color: #064e3b;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: #7f1d1d;
        }

        #trade-feedback {
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .loan-summary p {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .highlight {
            color: var(--accent-color);
            font-weight: 600;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color);
            color: var(--bg-color);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        #bank-feedback {
            min-height: 20px;
            margin-top: 10px;
            text-align: center;
            font-size: 0.9rem;
        }

        #bank-feedback.success {
            color: var(--success-color);
        }

        #bank-feedback.error {
            color: var(--danger-color);
        }

        /* Real Estate Styles */
        .re-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .re-container {
                grid-template-columns: 1fr;
            }
        }

        .listings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .property-card {
            background-color: var(--card-bg);
            border: 1px solid #334155;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .property-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .property-img-placeholder {
            height: 120px;
            background-color: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 2rem;
        }

        .property-info {
            padding: 15px;
        }

        .property-info h4 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .prop-price {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .prop-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .btn-buy-prop {
            width: 100%;
            padding: 8px;
            background-color: transparent;
            border: 1px solid var(--success-color);
            color: var(--success-color);
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-buy-prop:hover {
            background-color: var(--success-color);
            color: #064e3b;
        }

        .my-prop-item {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-color);
        }

        /* Education Styles */
        .edu-item {
            background-color: var(--card-bg);
            padding: 10px;
            border-bottom: 1px solid #334155;
            color: var(--text-secondary);
        }

        .course-card {
            background-color: var(--card-bg);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .course-card h4 {
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .course-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .btn-study {
            width: 100%;
            padding: 6px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-study:disabled {
            background-color: #1e293b;
            color: #64748b;
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 25px;
            border: 1px solid #334155;
            width: 90%;
            max-width: 700px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
            position: relative;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: white;
        }

        /* Wizard Selection Cards */
        .wizard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .wizard-option {
            background: #1e293b;
            border: 2px solid #334155;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wizard-option:hover {
            border-color: #38bdf8;
            transform: translateY(-2px);
        }

        .wizard-option.selected {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
        }

        /* JOB VIEW STYLES */
        .job-content-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .job-content-container {
                grid-template-columns: 1fr;
            }
        }

        .job-card {
            background-color: var(--card-bg);
            border: 1px solid #334155;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .job-card h4 {
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .job-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .career-path-container,
        .job-search-section,
        .holding-section {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .btn-apply {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            background-color: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-apply:hover {
            background-color: var(--accent-color);
            color: #0f172a;
        }



        .entrepreneur-banner {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #4f46e5, #0ea5e9);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }

        /* COMPANY DASHBOARD STYLES */
        .company-dashboard {
            background-color: var(--bg-color);
        }

        .company-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .company-finance-summary {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .fin-box {
            background: #0f172a;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
        }

        .fin-box .label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .fin-box .val {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .val.green {
            color: var(--success-color);
        }

        .val.red {
            color: var(--danger-color);
        }

        .company-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            border-bottom: 1px solid #334155;
            padding-bottom: 10px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            border-radius: 6px;
        }

        .tab-btn.active {
            background: var(--card-bg);
            color: var(--accent-color);
            border: 1px solid #334155;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .staff-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #334155;
            background: var(--card-bg);
        }

        .staff-row:first-child {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .staff-row:last-child {
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            border-bottom: none;
        }

        .staff-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .selection-card {
            background: var(--card-bg);
            border: 1px solid #334155;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        .selection-card:hover {
            border-color: var(--accent-color);
        }

        .selection-card.selected {
            border-color: var(--success-color);
            background: rgba(74, 222, 128, 0.1);
        }

        .invest-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .invest-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
            text-align: center;
        }

        .invest-card button {
            margin-top: 10px;
            padding: 8px 20px;
            background: var(--accent-color);
            border: none;
            border-radius: 6px;
            color: black;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-gold {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: black;
            font-weight: bold;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Inner Company Tab Styles */
        .strategy-section,
        .staff-section,
        .finance-actions {
            animation: fadeIn 0.3s ease-in-out;
        }

        .control-group {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .control-group input[type="number"] {
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-family: var(--font-main);
        }

        .control-group button {
            padding: 8px 15px;
            background: var(--accent-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            color: #0f172a;
        }

        .hire-panel {
            margin-top: 20px;
            padding: 15px;
            background: rgba(56, 189, 248, 0.05);
            border: 1px dashed var(--accent-color);
            border-radius: 8px;
        }

        .hire-panel h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--accent-color);
        }

        .btn-hire {
            background: var(--card-bg);
            border: 1px solid var(--accent-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .btn-hire:hover {
            background: var(--accent-color);
            color: #0f172a;
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 0.75rem;
            background: #334155;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }



        /* WIZARD & JOB UI OVERHAUL */
        .wizard-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
        }

        .step-dot {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--text-secondary);
            z-index: 1;
        }

        .step-dot.active {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: #0f172a;
        }

        .step-line {
            height: 2px;
            width: 100px;
            background: #334155;
            margin: 0 -10px;
        }

        .wizard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .wizard-option {
            background: var(--card-bg);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .wizard-option:hover {
            transform: translateY(-2px);
            border-color: var(--accent-color);
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.1);
        }

        .wizard-option.selected {
            border-color: var(--success-color);
            background: rgba(74, 222, 128, 0.05);
            box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.2);
        }

        /* JOB VIEW ENHANCEMENTS */
        .career-path-container {
            border: none !important;
            background: transparent !important;
            padding: 0 !important;
        }

        .promotion-status {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
            margin-bottom: 20px;
            position: relative;
        }

        .promotion-status::before {
            content: 'üéì TU CARRERA';
            position: absolute;
            top: -10px;
            left: 20px;
            background: var(--accent-color);
            color: #0f172a;
            font-size: 0.7rem;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .next-promotion-card {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .job-listings {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .job-card {
            background: var(--card-bg);
            border: 1px solid #334155;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s;
        }

        .job-card:hover {
            border-color: var(--accent-color);
        }

        .job-card h4 {
            font-size: 1.1rem;
            color: white;
        }

        .job-card p {
            color: var(--text-secondary);
            margin: 5px 0;
        }


        /* Scrollbar polish */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .btn-sm:hover {
            background: #475569;
        }
    </style>
</head>

<body>
    <!-- Stock Modal -->
    <div id="stock-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-modal">&times;</span>
            <h2 id="modal-stock-name">Stock Name (SYM)</h2>
            <p id="modal-stock-price" class="highlight" style="font-size:1.5rem">100 ‚Ç¨</p>
            <div style="background:#0f172a; padding:10px; border-radius:8px; margin:15px 0;">
                <canvas id="modal-stock-chart" width="500" height="200" style="width:100%"></canvas>
            </div>
            <div class="stock-fundamentals"
                style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:0.9rem;">
                <div><small>B¬∫ Por Acci√≥n (BPA)</small><br><span id="modal-stock-earnings"></span></div>
                <div><small>Volatilidad</small><br><span id="modal-stock-volatility"></span></div>
                <div><small>PER (Precio/Beneficio)</small><br><span id="modal-stock-per"></span></div>
                <div><small>Tendencia</small><br><span id="modal-stock-trend"></span></div>
            </div>
        </div>
    </div>

    <!-- Company Creation Wizard Modal -->
    <div id="company-wizard-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-wizard">&times;</span>
            <h2>üöÄ Fundar Nueva Empresa</h2>

            <div class="wizard-progress">
                <div class="step-dot active" id="step-dot-1">1</div>
                <div class="step-line"></div>
                <div class="step-dot" id="step-dot-2">2</div>
            </div>

            <!-- Step 1: Name & Type -->
            <div id="wizard-step-1" class="wizard-step active">
                <h3>1. Concepto del Negocio</h3>
                <div style="margin-bottom:20px;">
                    <label>Nombre de la Empresa</label><br>
                    <input type="text" id="wiz-name" placeholder="Ej. CyberCafe 2077"
                        style="width:100%; padding:10px; margin-top:5px; background:#1e293b; border:1px solid #334155; color:white; border-radius:5px;">
                </div>
                <p>Selecciona el Modelo de Negocio:</p>
                <div id="wiz-types-grid" class="wizard-grid">
                    <!-- Dynamic -->
                </div>
                <div style="margin-top:20px; text-align:right;">
                    <button class="btn-primary" id="btn-wiz-next-1">Siguiente ‚û°Ô∏è</button>
                </div>
            </div>

            <!-- Step 2: Location & Confirm -->
            <div id="wizard-step-2" class="wizard-step">
                <h3>2. Localizaci√≥n y Firma</h3>
                <p>Selecciona la ubicaci√≥n:</p>
                <div id="wiz-loc-grid" class="wizard-grid">
                    <!-- Dynamic -->
                </div>

                <div style="background:#0f172a; padding:15px; border-radius:8px; margin-top:20px;">
                    <h4>Resumen de Inversi√≥n</h4>
                    <p>Coste Licencia + Local: <span id="wiz-total-cost" class="bad-debt" style="font-size:1.2rem">0
                            ‚Ç¨</span></p>
                    <p style="font-size:0.9rem; color:#94a3b8">Capital Actual: <span id="wiz-current-cash"></span></p>
                </div>

                <div style="margin-top:20px; display:flex; justify-content:space-between;">
                    <button class="btn-primary" style="background:#64748b" id="btn-wiz-back-2">‚¨ÖÔ∏è Volver</button>
                    <button class="btn-primary" id="btn-wiz-finish" style="background:#10b981">üñãÔ∏è Firmar y
                        Fundar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app">
        <div id="app">
            <header class="app-header"
                style="display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; padding: 10px 20px; background:#0f172a; border-bottom:1px solid #334155; gap:20px;">

                <!-- LEFT: Profile & Actions -->
                <div class="header-left" style="display:flex; align-items:center; gap:15px;">
                    <div id="player-profile-display"
                        style="display:flex; align-items:center; gap:8px; background:#1e293b; padding:5px 12px; border-radius:20px; border:1px solid #334155;">
                        <span style="font-size:1.2rem;">üë§</span>
                        <span id="header-player-name"
                            style="color:#fcd34d; font-weight:bold; font-size:0.9rem;">Jugador</span>
                    </div>
                    <button onclick="alert(PersistenceModule.saveGame().message)"
                        style="background:transparent; border:1px solid #475569; color:#94a3b8; padding:5px 10px; border-radius:6px; cursor:pointer; font-size:0.8rem; transition:all 0.2s;">
                        üíæ Guardar
                    </button>
                </div>

                <!-- CENTER: Next Turn -->
                <div class="header-center" style="display:flex; justify-content:center;">
                    <button id="next-turn-btn"
                        style="background:linear-gradient(135deg, #3b82f6, #2563eb); color:white; border:none; padding:10px 30px; border-radius:8px; font-weight:bold; font-size:1rem; cursor:pointer; box-shadow:0 4px 10px rgba(59, 130, 246, 0.4); transition:transform 0.2s;">
                        Siguiente Mes ‚û°Ô∏è
                    </button>
                </div>

                <!-- RIGHT: Stats -->
                <div class="header-right" style="display:flex; justify-content:flex-end; gap:10px;">
                    <div style="text-align:right;">
                        <div id="money-display"
                            style="font-size:1.2rem; font-weight:bold; color:#4ade80; font-family:monospace;">10.000 ‚Ç¨
                        </div>
                        <div id="date-display" style="font-size:0.8rem; color:#94a3b8;">Mes 1, A√±o 1</div>
                    </div>
                </div>
            </header>

            <main>
                <nav id="main-nav" class="desktop-nav"
                    style="display:flex; align-items:center; gap:5px; padding-right:0;">
                    <button class="nav-btn active" data-view="dashboard">Resumen</button>
                    <button class="nav-btn" data-view="education">Formaci√≥n</button>
                    <button class="nav-btn" data-view="job">Trabajo</button>
                    <button class="nav-btn" data-view="bank">Banco</button>
                    <button class="nav-btn" data-view="real-estate">Inmobiliaria</button>
                    <button class="nav-btn" data-view="market">Bolsa</button>
                </nav>

                <section id="view-container">
                    <!-- Views will be rendered here -->
                    <div id="dashboard-view" class="view active">
                        <h2>Resumen Financiero</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>Patrimonio Neto</h3>
                                <p id="net-worth">1,000 ‚Ç¨</p>
                            </div>
                            <div class="stat-card">
                                <h3>Ingresos Mensuales</h3>
                                <p id="monthly-income">0 ‚Ç¨</p>
                            </div>
                            <div class="stat-card">
                                <h3>Gastos Mensuales</h3>
                                <p id="monthly-expenses">0 ‚Ç¨</p>
                            </div>
                            <div class="stat-card">
                                <h3>Edad</h3>
                                <p id="age-display">18 a√±os</p>
                            </div>
                        </div>

                        <div class="chart-container"
                            style="margin-top: 30px; background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid #334155;">
                            <h3>Evoluci√≥n Patrimonio</h3>
                            <canvas id="net-worth-chart" width="800" height="300"
                                style="width: 100%; height: auto;"></canvas>
                        </div>

                        <button id="next-turn-btn"
                            style="margin-top: 30px; width: 100%; padding: 15px; background: linear-gradient(135deg, #38bdf8, #0ea5e9); border: none; border-radius: 8px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: transform 0.1s;">
                            Siguiente Mes ‚ñ∂
                        </button>
                    </div>

                    <div id="market-view" class="view">
                        <h2>Mercado de Valores</h2>
                        <div class="market-container">
                            <div class="stocks-list">
                                <h3>Acciones Disponibles</h3>
                                <div id="stocks-grid" class="stocks-grid">
                                    <!-- Stock Items injected here -->
                                </div>
                            </div>

                            <div class="portfolio-panel">
                                <h3>Tu Portafolio</h3>
                                <div id="portfolio-list">
                                    <p class="empty-msg">No tienes inversiones todav√≠a.</p>
                                </div>

                                <div class="trade-panel">
                                    <h3>Operar</h3>
                                    <div class="trade-controls">
                                        <select id="stock-select"></select>
                                        <input type="number" id="trade-amount" placeholder="Cantidad" min="1" value="1">
                                        <div class="trade-actions">
                                            <button id="btn-buy" class="btn-success">Comprar</button>
                                            <button id="btn-sell" class="btn-danger">Vender</button>
                                        </div>
                                        <p id="trade-feedback"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="bank-view" class="view">
                        <h2>Banco Central</h2>
                        <div class="bank-container">
                            <div class="loans-panel">
                                <h3>Mis Pr√©stamos</h3>
                                <div id="active-loans-list">
                                    <!-- Loans injected here -->
                                </div>
                            </div>

                            <div class="new-loan-panel">
                                <h3>Solicitar Pr√©stamo Personal</h3>
                                <div class="loan-calculator">
                                    <p>L√≠mite estimado: <span id="loan-limit" class="highlight">0 ‚Ç¨</span></p>
                                    <div class="form-group">
                                        <label>Cantidad:</label>
                                        <input type="number" id="loan-amount" placeholder="Ej. 5000">
                                    </div>
                                    <div class="form-group">
                                        <label>Plazo (A√±os):</label>
                                        <input type="range" id="loan-years" min="1" max="5" value="2">
                                        <span id="loan-years-display">2 a√±os</span>
                                    </div>
                                    <div class="loan-summary">
                                        <p>Inter√©s: <span class="highlight">12%</span></p>
                                        <p>Cuota estimada: <span id="loan-monthly-payment">0 ‚Ç¨</span></p>
                                    </div>
                                    <button id="btn-request-loan" class="btn-primary">Solicitar Dinero</button>
                                    <p id="bank-feedback"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="real-estate-view" class="view">
                        <h2>Bienes Inmobiliarios</h2>
                        <div class="re-container">
                            <div class="listings-panel">
                                <h3>Oportunidades de Mercado</h3>
                                <div id="property-listings" class="listings-grid">
                                    <!-- Properties injected here -->
                                </div>
                            </div>

                            <div class="my-properties-panel">
                                <h3>Mis Propiedades</h3>
                                <div id="my-properties-list">
                                    <p class="empty-msg">No tienes propiedades.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="job-view" class="view">
                        <h2>Carrera Profesional</h2>
                        <div class="job-container">
                            <div class="current-job-panel">
                                <h3>Puesto Actual</h3>
                                <div class="job-card main-job">
                                    <h4 id="job-title-display">Reponedor</h4>
                                    <p class="job-salary">Salario: <span id="job-salary-display">1,100 ‚Ç¨</span>/mes</p>
                                    <p class="job-exp">Experiencia acumulada: <span id="job-exp-display">0</span> meses
                                    </p>
                                </div>

                                <div id="promotion-section" class="promotion-area">
                                    <h4>Pr√≥ximo Ascenso Interno</h4>
                                    <p id="next-job-info">Cargando...</p>
                                    <button id="btn-promote" class="btn-primary" disabled>Solicitar Ascenso</button>
                                </div>
                            </div>

                            <!-- NEW: Job Market -->
                            <div class="job-market-panel"
                                style="margin-top: 20px; border-top: 1px solid #334155; padding-top: 20px;">
                                <h3>Mercado Laboral (Otras Vacantes)</h3>
                                <div id="job-market-list" class="listings-grid">
                                    <!-- Job Offers injected here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="education-view" class="view">
                        <h2>Formaci√≥n y Estudios</h2>
                        <div class="education-container"
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="current-edu-panel">
                                <h3>Tu Formaci√≥n</h3>
                                <div id="current-education-list">
                                    <!-- List injected here -->
                                    <div class="edu-item">Bachillerato</div>
                                </div>
                            </div>
                            <div class="courses-panel">
                                <h3>Cursos Disponibles</h3>
                                <div id="courses-list" class="listings-grid">
                                    <!-- Courses injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Bundled Logic -->
        <!-- MOBILE BOTTOM NAV -->
        <nav id="bottom-nav">
            <button class="b-nav-item active" data-view="dashboard">
                <span class="icon">üè†</span>
                <span class="label">Resumen</span>
            </button>
            <button class="b-nav-item" data-view="education">
                <span class="icon">üéì</span>
                <span class="label">Edu</span>
            </button>
            <button class="b-nav-item" data-view="job">
                <span class="icon">üíº</span>
                <span class="label">Trabajo</span>
            </button>
            <button class="b-nav-item" data-view="bank">
                <span class="icon">üè¶</span>
                <span class="label">Banco</span>
            </button>
            <button class="b-nav-item" data-view="real-estate">
                <span class="icon">üèòÔ∏è</span>
                <span class="label">Inmuebles</span>
            </button>
            <button class="b-nav-item" data-view="market">
                <span class="icon">üìà</span>
                <span class="label">Bolsa</span>
            </button>
        </nav>
        <script>
            /*******************************************************
             * STATE
             *******************************************************/
            const GameState = {
                playerName: 'Inversor',
                month: 1,
                year: 1,
                cash: 10000,
                netWorth: 10000,
                salary: 1200,
                expenses: 800,
                jobTitle: 'Reponedor de Supermercado',
                inventory: {
                    stocks: [],
                    realEstate: []
                },
                loans: [],
                // Phase 2
                age: 18,
                education: ['Bachillerato'],
                isStudying: false,
                currentCourse: null, // { name: 'FP Inform√°tica', remainingMonths: 12, costMonthly: 0 }
                history: {
                    netWorth: [10000],
                    cash: [10000],
                    assets: [0],
                    debt: [0],
                    labels: ['Inicio']
                }
            };

            function updateNetWorth() {
                let assets = GameState.cash;
                GameState.inventory.stocks.forEach(stock => {
                    const liveStock = StockMarket.getStock(stock.symbol);
                    const currentPrice = liveStock ? liveStock.price : stock.avgPrice;
                    assets += stock.quantity * currentPrice;
                });
                GameState.inventory.realEstate.forEach(property => {
                    assets += property.price; // Use price or value
                });
                let liabilities = 0;
                GameState.loans.forEach(loan => {
                    liabilities += loan.remainingBalance;
                });

                GameState.netWorth = assets - liabilities;
                return GameState.netWorth;
            }

            /*******************************************************
             * CHART MODULE (Simple Canvas Header)
             *******************************************************/
            /*******************************************************
             * CHART MODULE (Premium Chart.js)
             *******************************************************/
            const ChartModule = {
                instance: null,

                drawChart(canvasId, history) {
                    const ctx = document.getElementById(canvasId).getContext('2d');

                    // Destroy previous to avoid overlay
                    if (this.instance) {
                        this.instance.destroy();
                    }

                    // Gradients
                    const gradientNW = ctx.createLinearGradient(0, 0, 0, 400);
                    gradientNW.addColorStop(0, 'rgba(250, 204, 21, 0.5)'); // Yellow/Gold
                    gradientNW.addColorStop(1, 'rgba(250, 204, 21, 0.0)');

                    const gradientCash = ctx.createLinearGradient(0, 0, 0, 400);
                    gradientCash.addColorStop(0, 'rgba(74, 222, 128, 0.4)'); // Green
                    gradientCash.addColorStop(1, 'rgba(74, 222, 128, 0.0)');

                    this.instance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: history.labels,
                            datasets: [
                                {
                                    label: 'Patrimonio Neto',
                                    data: history.netWorth,
                                    borderColor: '#facc15',
                                    backgroundColor: gradientNW,
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 0
                                },
                                {
                                    label: 'Liquidez',
                                    data: history.cash,
                                    borderColor: '#4ade80', // Green
                                    backgroundColor: gradientCash,
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 0
                                },
                                {
                                    label: 'Deuda',
                                    data: history.debt,
                                    borderColor: '#f87171', // Red
                                    borderWidth: 2,
                                    fill: false,
                                    tension: 0.4,
                                    pointRadius: 0
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: {
                                legend: {
                                    labels: { color: '#94a3b8' }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                    titleColor: '#f1f5f9',
                                    bodyColor: '#cbd5e1',
                                    borderColor: '#334155',
                                    borderWidth: 1
                                }
                            },
                            scales: {
                                x: {
                                    grid: { color: '#334155' },
                                    ticks: { color: '#94a3b8', maxTicksLimit: 8 }
                                },
                                y: {
                                    grid: { color: '#334155' },
                                    ticks: { color: '#94a3b8', callback: (val) => formatCurrency(val) }
                                }
                            }
                        }
                    });
                },
                drawStockChart(canvasId, stock, timeframe) {
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    if (this.instanceStock) {
                        this.instanceStock.destroy();
                    }

                    let data = stock.history || [];
                    let labels = Array.from({ length: data.length }, (_, i) => i);

                    // Limit data
                    if (timeframe !== 999) { // 999 = MAX
                        data = data.slice(-timeframe);
                        labels = labels.slice(-timeframe);
                    }

                    if (data.length === 0) return;

                    const startPrice = data[0];
                    const endPrice = data[data.length - 1];
                    const isPositive = endPrice >= startPrice;
                    const color = isPositive ? '#4ade80' : '#f87171';
                    const bgColor = isPositive ? 'rgba(74, 222, 128, 0.1)' : 'rgba(248, 113, 113, 0.1)';

                    this.instanceStock = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                borderColor: color,
                                backgroundColor: bgColor,
                                borderWidth: 2,
                                fill: true,
                                pointRadius: 0,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                            scales: {
                                x: { display: false },
                                y: { display: false } // Minimalist sparkline style or show ticks? User said "historial", imply detail.
                                // Let's show Y ticks for readability
                            }
                        }
                    });
                }
            };

            /*******************************************************
             * PERSISTENCE MODULE
             *******************************************************/
            const PersistenceModule = {
                SAVE_KEY: 'inversion_game_v1',

                saveGame() {
                    try {
                        const data = JSON.stringify(GameState);
                        localStorage.setItem(this.SAVE_KEY, data);
                        return { success: true, message: 'Partida guardada correctamente.' };
                    } catch (e) {
                        return { success: false, message: 'Error al guardar: ' + e.message };
                    }
                },

                loadGame() {
                    try {
                        const data = localStorage.getItem(this.SAVE_KEY);
                        if (!data) return { success: false, message: 'No hay partida guardada.' };
                        const loadedState = JSON.parse(data);

                        // Merge logic to avoid breaking references if needed, but complete replace is cleaner for this scale
                        Object.assign(GameState, loadedState);

                        // Re-instantiate complex objects if they were lost (Dates, etc) - none here currently
                        return { success: true, message: `Bienvenido de nuevo, ${GameState.playerName}` };
                    } catch (e) {
                        return { success: false, message: 'Error al cargar: ' + e.message };
                    }
                },

                checkSave() {
                    return !!localStorage.getItem(this.SAVE_KEY);
                },

                resetGame(name) {
                    localStorage.removeItem(this.SAVE_KEY);
                    location.reload(); // Simplest way to reset state
                }
            };

            /*******************************************************
             * STOCK MARKET
             *******************************************************/
            const StockMarket = {
                stocks: [
                    { symbol: 'SP500', name: 'S&P 500', price: 4500.00, trend: 0.00, history: [], volatility: 0.08, type: 'index' },
                    { symbol: 'NDX', name: 'Nasdaq 100', price: 15500.00, trend: 0.00, history: [], volatility: 0.12, type: 'index' },
                    { symbol: 'IBEX', name: 'Ibex 35 ETF', price: 85.50, trend: 0.05, history: [], volatility: 0.15, earnings: 5.2 },
                    { symbol: 'TSLA', name: 'Tesla Inc.', price: 230.10, trend: -0.02, history: [], volatility: 0.35, earnings: 12.5 },
                    { symbol: 'REP', name: 'Repsol', price: 14.20, trend: 0.01, history: [], volatility: 0.10, earnings: 2.1 },
                    { symbol: 'AAPL', name: 'Apple', price: 175.00, trend: 0.03, history: [], volatility: 0.12, earnings: 8.4 },
                    { symbol: 'SAN', name: 'Banco Santander', price: 3.50, trend: 0.00, history: [], volatility: 0.18, earnings: 0.45 }
                ],

                init() {
                    // Initialize history for graph
                    this.stocks.forEach(s => {
                        s.history = [s.price];
                        // Add some fake history
                        for (let i = 0; i < 10; i++) {
                            s.history.unshift(s.price * (1 - (Math.random() * 0.1 - 0.05)));
                        }
                    });
                },

                getStock(symbol) {
                    return this.stocks.find(s => s.symbol === symbol);
                },

                nextTurn() {
                    this.stocks.forEach(stock => {
                        let totalChange = 0;

                        if (stock.type === 'index') {
                            // INDEX LOGIC: Mean reversion to +9% annual (~0.72% monthly)
                            // Simple Random Walk with drift
                            const targetMonthlyReturn = 0.0072; // ~9% APY
                            // Random fluctuation centered on 0
                            const fluctuation = (Math.random() * stock.volatility) - (stock.volatility / 2);
                            totalChange = targetMonthlyReturn + fluctuation;
                        } else {
                            // REGULAR STOCK LOGIC
                            // Volatilidad based on specific stock stat
                            const changePercent = (Math.random() * (stock.volatility || 0.20)) - (stock.volatility / 2 || 0.10);
                            const momentum = stock.trend * 0.3;
                            totalChange = changePercent + momentum;

                            if (Math.random() < 0.05) {
                                const event = Math.random() < 0.5 ? -0.25 : 0.25;
                                totalChange += event;
                            }
                        }

                        stock.price = stock.price * (1 + totalChange);
                        stock.trend = totalChange;
                        if (stock.price < 0.10) stock.price = 0.10;

                        // Update History
                        stock.history.push(stock.price);
                        if (stock.history.length > 20) stock.history.shift();
                    });
                },

                buyStock(symbol, qty) {
                    const stock = this.getStock(symbol);
                    if (!stock) return { success: false, message: 'Acci√≥n no encontrada' };
                    const cost = stock.price * qty;
                    if (GameState.cash < cost) return { success: false, message: 'Fondos insuficientes' };

                    GameState.cash -= cost;
                    let pItem = GameState.inventory.stocks.find(s => s.symbol === symbol);
                    if (pItem) {
                        const totalCost = (pItem.quantity * pItem.avgPrice) + cost;
                        pItem.quantity += qty;
                        pItem.avgPrice = totalCost / pItem.quantity;
                    } else {
                        GameState.inventory.stocks.push({ symbol: symbol, quantity: qty, avgPrice: stock.price });
                    }
                    return { success: true, message: `Compradas ${qty} acciones de ${symbol} por ${formatCurrency(cost)}` };
                },

                sellStock(symbol, qty) {
                    const stock = this.getStock(symbol);
                    if (!stock) return { success: false, message: 'Acci√≥n no encontrada' };
                    let pItem = GameState.inventory.stocks.find(s => s.symbol === symbol);
                    if (!pItem || pItem.quantity < qty) return { success: false, message: 'No tienes suficientes acciones' };

                    const value = stock.price * qty;
                    GameState.cash += value;
                    pItem.quantity -= qty;
                    if (pItem.quantity <= 0) {
                        GameState.inventory.stocks = GameState.inventory.stocks.filter(s => s.symbol !== symbol);
                    }
                    return { success: true, message: `Vendidas ${qty} acciones de ${symbol} por ${formatCurrency(value)}` };
                }
            };

            const Portfolio = {
                buy(stockSymbol, quantity, gameState) {
                    const stock = StockMarket.getStock(stockSymbol);
                    const cost = stock.price * quantity;
                    const commission = cost * 0.005;
                    const totalCost = cost + commission;
                    if (gameState.cash >= totalCost) {
                        gameState.cash -= totalCost;
                        const existing = gameState.inventory.stocks.find(s => s.symbol === stockSymbol);
                        if (existing) {
                            const totalValue = (existing.quantity * existing.avgPrice) + cost;
                            existing.quantity += quantity;
                            existing.avgPrice = totalValue / existing.quantity;
                        } else {
                            gameState.inventory.stocks.push({
                                symbol: stockSymbol,
                                name: stock.name,
                                quantity: quantity,
                                avgPrice: stock.price
                            });
                        }
                        return { success: true, message: `Has comprado ${quantity} acciones de ${stock.name}` };
                    }
                    return { success: false, message: 'Dinero insuficiente' };
                },
                sell(stockSymbol, quantity, gameState) {
                    const existing = gameState.inventory.stocks.find(s => s.symbol === stockSymbol);
                    if (existing && existing.quantity >= quantity) {
                        const stock = StockMarket.getStock(stockSymbol);
                        const value = stock.price * quantity;
                        const commission = value * 0.005;
                        const totalReturn = value - commission;
                        gameState.cash += totalReturn;
                        existing.quantity -= quantity;
                        if (existing.quantity === 0) {
                            gameState.inventory.stocks = gameState.inventory.stocks.filter(s => s.symbol !== stockSymbol);
                        }
                        return { success: true, message: `Has vendido ${quantity} acciones de ${stock.name}` };
                    }
                    return { success: false, message: 'No tienes suficientes acciones' };
                }
            };

            /*******************************************************
             * BANK
             *******************************************************/
            const Bank = {
                INTEREST_RATES: {
                    personal: 0.12,
                    mortgage: 0.04
                },
                getMaxLoanAmount() {
                    // Business Loan Logic
                    if (GameState.company) {
                        const co = GameState.company;
                        const typeConf = CompanyModule.businessTypes[co.typeId];
                        const openCost = typeConf.cost;

                        let avgRev = co.revenueLastMonth || 0;
                        if (co.financialHistory && co.financialHistory.length > 0) {
                            const last6 = co.financialHistory.slice(-6);
                            const sum = last6.reduce((acc, curr) => acc + curr.revenue, 0);
                            avgRev = sum / last6.length;
                        }

                        const annualRev = avgRev * 12;
                        return Math.floor(openCost + (annualRev * 2));
                    }

                    // Personal Loan Logic
                    const netIncome = GameState.salary - GameState.expenses;
                    const maxMonthlyPayment = Math.max(0, netIncome) * 0.40;
                    const r = this.INTEREST_RATES.personal / 12;
                    const n = 60;
                    const maxPrincipal = (maxMonthlyPayment * (1 - Math.pow(1 + r, -n))) / r;
                    const absoluteCap = Math.max(5000, GameState.netWorth * 2);
                    return Math.min(Math.floor(maxPrincipal), absoluteCap);
                },
                takeLoan(amount, years) {
                    if (amount <= 0) return { success: false, message: 'La cantidad debe ser mayor a 0' };

                    const max = this.getMaxLoanAmount();
                    const currentDebt = GameState.loans.reduce((sum, l) => sum + l.remainingBalance, 0);
                    const available = Math.max(0, max - currentDebt);

                    if (amount > available) return { success: false, message: `L√≠mite excedido. Te quedan ${formatCurrency(available)} de cr√©dito disponible (Total: ${formatCurrency(max)}).` };

                    const isBusiness = !!GameState.company;
                    const annualRate = isBusiness ? 0.05 : this.INTEREST_RATES.personal;

                    const monthlyRate = annualRate / 12;
                    const termMonths = years * 12;
                    const monthlyPayment = (amount * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -termMonths));
                    const loan = {
                        id: Date.now(),
                        type: isBusiness ? 'Cr√©dito Empresarial' : 'Pr√©stamo Personal',
                        principal: amount,
                        termMonths: termMonths,
                        remainingMonths: termMonths,
                        monthlyPayment: monthlyPayment,
                        interestRate: annualRate,
                        remainingBalance: amount
                    };
                    GameState.loans.push(loan);
                    GameState.cash += amount;
                    return { success: true, message: `Pr√©stamo concedido. Cuota: ${monthlyPayment.toFixed(2)}‚Ç¨/mes` };
                },
                payLoanTotally(loanId) {
                    const loanIndex = GameState.loans.findIndex(l => l.id === loanId);
                    if (loanIndex === -1) return { success: false, message: 'Pr√©stamo no encontrado' };
                    const loan = GameState.loans[loanIndex];
                    if (GameState.cash >= loan.remainingBalance) {
                        GameState.cash -= loan.remainingBalance;
                        GameState.loans.splice(loanIndex, 1);
                        return { success: true, message: 'Pr√©stamo liquidado totalmente' };
                    }
                    return { success: false, message: 'Dinero insuficiente para liquidar' };
                },
                nextTurn() {
                    let totalPaid = 0;
                    const loansToRemove = [];
                    GameState.loans.forEach((loan, index) => {
                        if (GameState.cash >= loan.monthlyPayment) {
                            GameState.cash -= loan.monthlyPayment;
                            totalPaid += loan.monthlyPayment;
                            const interestPayment = loan.remainingBalance * (loan.interestRate / 12);
                            const principalPayment = loan.monthlyPayment - interestPayment;
                            loan.remainingBalance -= principalPayment;
                            loan.remainingMonths--;
                            if (loan.remainingMonths <= 0 || loan.remainingBalance <= 1) {
                                loansToRemove.push(index);
                            }
                        } else {
                            GameState.cash -= loan.monthlyPayment; // Deuda aumenta
                        }
                    });
                    for (let i = loansToRemove.length - 1; i >= 0; i--) {
                        GameState.loans.splice(loansToRemove[i], 1);
                    }
                    return totalPaid;
                }
            };

            /*******************************************************
             * REAL ESTATE
             *******************************************************/
            const RealEstate = {
                availableProperties: [],
                types: [
                    { name: 'Plaza de Garaje', minPrice: 15000, maxPrice: 30000, yield: 0.05 },
                    { name: 'Piso Peque√±o', minPrice: 80000, maxPrice: 150000, yield: 0.045 },
                    { name: 'Apartamento Tur√≠stico', minPrice: 120000, maxPrice: 200000, yield: 0.06 },
                    { name: 'Local Comercial', minPrice: 200000, maxPrice: 400000, yield: 0.055 },
                    { name: 'Chalet', minPrice: 400000, maxPrice: 800000, yield: 0.035 }
                ],
                marketTrend: 1.0, // 1.0 = neutral

                generateListings() {
                    this.availableProperties = [];
                    for (let i = 0; i < 6; i++) {
                        const typeVar = this.types[Math.floor(Math.random() * this.types.length)];
                        const sizeM2 = Math.floor(Math.random() * (200 - 50) + 50);
                        const baseZonePrice = Math.floor(Math.random() * (4000 - 1500) + 1500);
                        const marketMarkup = (Math.random() * 0.4) - 0.2;
                        const pricePerM2 = Math.floor(baseZonePrice * (1 + marketMarkup));
                        const price = sizeM2 * pricePerM2;
                        const actualYield = typeVar.yield + (Math.random() * 0.02 - 0.01);
                        const monthlyRent = Math.floor((price * actualYield) / 12);

                        this.availableProperties.push({
                            id: Date.now() + i,
                            name: typeVar.name,
                            price: price,
                            monthlyRent: monthlyRent,
                            downPaymentPct: 0.20,
                            sizeM2: sizeM2,
                            zoneAvgPrice: baseZonePrice
                        });
                    }
                },

                nextTurn() {
                    const change = (Math.random() * 0.06) - 0.025;
                    this.marketTrend *= (1 + change);
                    GameState.inventory.realEstate.forEach(prop => {
                        const localChange = (Math.random() * 0.04) - 0.02;
                        const totalChange = change + localChange;
                        prop.price = Math.floor(prop.price * (1 + totalChange));
                    });
                },

                buyProperty(propertyId, useMortgage = true) {
                    const propertyIndex = this.availableProperties.findIndex(p => p.id === propertyId);
                    if (propertyIndex === -1) return { success: false, message: 'Propiedad no encontrada' };
                    const property = this.availableProperties[propertyIndex];
                    const downPayment = useMortgage ? property.price * property.downPaymentPct : property.price;
                    const loanAmount = property.price - downPayment;

                    if (GameState.cash < downPayment) {
                        return { success: false, message: 'Necesitas m√°s dinero para la entrada' };
                    }

                    if (useMortgage && loanAmount > 0) {
                        const r = Bank.INTEREST_RATES.mortgage / 12;
                        const n = 240;
                        const monthlyPayment = (loanAmount * r) / (1 - Math.pow(1 + r, -n));
                        const mortgageId = Date.now();

                        GameState.loans.push({
                            id: mortgageId,
                            type: 'Hipotecario',
                            principal: loanAmount,
                            termMonths: n,
                            remainingMonths: n,
                            monthlyPayment: monthlyPayment,
                            interestRate: Bank.INTEREST_RATES.mortgage,
                            remainingBalance: loanAmount
                        });

                        property.mortgageId = mortgageId;
                    }

                    GameState.cash -= downPayment;
                    property.purchasePrice = property.price;
                    GameState.inventory.realEstate.push(property);
                    this.availableProperties.splice(propertyIndex, 1);
                    return { success: true, message: `¬°Has comprado: ${property.name}!` };
                },

                sellProperty(propertyId) {
                    const propIndex = GameState.inventory.realEstate.findIndex(p => p.id === propertyId);
                    if (propIndex === -1) return { success: false, message: 'No posees esta propiedad.' };

                    const property = GameState.inventory.realEstate[propIndex];
                    const marketValue = property.price;

                    let mortgageCost = 0;
                    if (property.mortgageId) {
                        const loanIndex = GameState.loans.findIndex(l => l.id === property.mortgageId);
                        if (loanIndex !== -1) {
                            mortgageCost = GameState.loans[loanIndex].remainingBalance;
                            GameState.loans.splice(loanIndex, 1);
                        }
                    }

                    const netProfit = marketValue - mortgageCost;
                    GameState.cash += netProfit;
                    GameState.inventory.realEstate.splice(propIndex, 1);
                    return { success: true, message: `Propiedad vendida por ${formatCurrency(marketValue)}. Hipoteca cancelada: ${formatCurrency(mortgageCost)}. Neto: ${formatCurrency(netProfit)}` };
                }
            };
            RealEstate.generateListings();

            /*******************************************************
             * EDUCATION SYSTEM
             *******************************************************/
            const EducationModule = {
                courses: [
                    { id: 'fp_informatica', name: 'FP Desarrollo Web', type: 'FP', costYear: 500, durationMonths: 12, level: 1 },
                    { id: 'grado_economia', name: 'Grado en Econom√≠a', type: 'Carrera', costYear: 1500, durationMonths: 24, level: 2 },
                    { id: 'grado_ing_sw', name: 'Ingenier√≠a Software', type: 'Carrera', costYear: 2000, durationMonths: 24, level: 2 },
                    { id: 'master_mba', name: 'M√°ster MBA', type: 'Master', costYear: 5000, durationMonths: 12, level: 3, req: 'Carrera' }
                ],

                getCourse(id) {
                    return this.courses.find(c => c.id === id);
                },

                startCourse(courseId) {
                    if (GameState.currentCourse) return { success: false, message: 'Ya est√°s estudiando.' };
                    const course = this.courses.find(c => c.id === courseId);
                    const cost = course.costYear;
                    if (GameState.cash < cost) return { success: false, message: 'No tienes dinero suficiente para la matr√≠cula.' };

                    if (course.req === 'Carrera' && !GameState.education.some(e => e.includes('Grado') || e.includes('Ingenier√≠a'))) {
                        return { success: false, message: 'Necesitas una carrera previa.' };
                    }

                    GameState.cash -= cost;
                    GameState.isStudying = true;
                    GameState.currentCourse = {
                        ...course,
                        monthsLeft: course.durationMonths
                    };

                    return { success: true, message: `Has empezado: ${course.name}` };
                },

                nextTurn() {
                    if (GameState.currentCourse) {
                        GameState.currentCourse.monthsLeft--;
                        if (GameState.currentCourse.monthsLeft <= 0) {
                            this.completeCourse();
                        }
                    }
                },

                completeCourse() {
                    const course = GameState.currentCourse;
                    GameState.education.push(course.name);
                    GameState.isStudying = false;
                    GameState.currentCourse = null;

                    let message = `¬°Felicidades! Has completado tus estudios: ${course.name}.`;

                    let relatedJob = null;
                    let relatedPath = null;

                    if (course.id.includes('informatica') || course.id.includes('ing_sw')) {
                        const techPath = JobSystem.careers['tech'];
                        if (course.type === 'FP' || course.type === 'Carrera') {
                            relatedPath = 'tech';
                            relatedJob = techPath.find(j => j.title === 'Becario IT');
                            if (course.type === 'Carrera') relatedJob = techPath.find(j => j.title === 'Junior Dev');
                        }
                    } else if (course.id.includes('economia') || course.id.includes('mba')) {
                        const commPath = JobSystem.careers['comercio'];
                        if (course.type === 'Carrera') relatedJob = commPath.find(j => j.title === 'Encargado de Tienda');
                        if (course.type === 'Master') relatedJob = commPath.find(j => j.title === 'Gerente Regional');
                    }

                    alert(message);
                    UI.updateEducation(this);

                    if (relatedJob && relatedPath) {
                        if (confirm(`GRACIAS A TUS ESTUDIOS: Se ha abierto una vacante para ${relatedJob.title} (${relatedJob.salary}‚Ç¨/mes). ¬øQuieres aceptar el puesto/pr√°cticas inmediatamente?`)) {
                            JobSystem.switchJobEnhanced(relatedPath, relatedJob);
                            UI.updateJob(JobSystem);
                            UI.updateDashboard();
                        }
                    }
                }
            };

            /*******************************************************
             * COMPANY MODULE (Entrepreneurship Mode "Big Ambitions")
             *******************************************************/
            const CompanyModule = {
                // Configuration
                businessTypes: {
                    'cafe': { name: 'Cafeter√≠a', cost: 20000, baseDemand: 800, baseTicket: 5, cogsPct: 0.25, productivityPerStaff: 800, volatility: 0.05, tier: 1, baseWage: 1200 },
                    'retail_clothing': { name: 'Tienda de Ropa', cost: 50000, baseDemand: 100, baseTicket: 55, cogsPct: 0.4, productivityPerStaff: 120, volatility: 0.2, tier: 1, baseWage: 1200 },
                    'marketing_agency': { name: 'Agencia Marketing', cost: 250000, baseDemand: 8, baseTicket: 2000, cogsPct: 0.1, productivityPerStaff: 4, volatility: 0.3, tier: 1, baseWage: 2800 },
                    'tech_startup': { name: 'Startup SaaS', cost: 750000, baseDemand: 100, baseTicket: 100, cogsPct: 0.05, productivityPerStaff: 200, volatility: 0.6, tier: 2, baseWage: 3000 }
                },
                locations: {
                    'suburbs': { name: 'Afueras', rentMult: 0.5, trafficMult: 0.8 },
                    'downtown': { name: 'Centro Ciudad', rentMult: 1.5, trafficMult: 1.0 },
                    'business_district': { name: 'Distrito Financiero', rentMult: 3.0, trafficMult: 1.2 }
                },
                providers: {
                    'cheap': { name: 'Mayorista Low-Cost', priceMod: 0.8, quality: 0.4, reliability: 0.7 },
                    'standard': { name: 'Distribuidor Est√°ndar', priceMod: 1.0, quality: 0.7, reliability: 0.9 },
                    'premium': { name: 'Importador Premium', priceMod: 1.4, quality: 1.0, reliability: 0.99 }
                },
                marketingChannels: {
                    'none': { name: 'Sin Publicidad', cost: 0, impact: 1.0 },
                    'social': { name: 'Redes Sociales', cost: 500, impact: 1.3 },
                    'local': { name: 'Radio/Prensa Local', cost: 1500, impact: 1.6 },
                    'influencers': { name: 'Campa√±a Influencers', cost: 5000, impact: 2.2 }
                },

                // Logic
                createCompany(name, typeKey, locKey) {
                    const type = this.businessTypes[typeKey];
                    const loc = this.locations[locKey];
                    if (!type || !loc) return { success: false, message: 'Configuraci√≥n inv√°lida.' };
                    if (GameState.cash < type.cost) return { success: false, message: `Necesitas ${formatCurrency(type.cost)}.` };

                    GameState.cash -= type.cost;

                    GameState.company = {
                        name: name,
                        typeId: typeKey,
                        typeName: type.name,
                        locationId: locKey,
                        locationName: loc.name,

                        // Financials
                        cash: 5000,
                        revenueLastMonth: 0,
                        expensesLastMonth: 0,
                        profitLastMonth: 0,

                        // Analytics
                        revenueHistory: [],
                        profitHistory: [],

                        // State
                        reputation: 3.0,
                        customerSatisfaction: 0.7,

                        // Assets / Levels
                        marketingLevel: 1,
                        productLevel: 1,
                        maxStaff: 5, // TIER 1 CAP

                        // Decisions
                        marketingChannel: 'none',
                        providerId: 'standard',
                        staff: [],

                        events: [],
                        age: 0
                    };

                    GameState.jobTitle = `CEO de ${name}`;
                    GameState.salary = 0;
                    JobSystem.currentCareerPath = 'entrepreneur';

                    return { success: true, message: `Has fundado ${name}.` };
                },

                hireStaff(role, salary, skill) {
                    if (!GameState.company) return;
                    const co = GameState.company;

                    if (co.staff.length >= co.maxStaff) {
                        return { success: false, message: `L√≠mite de personal alcanzado (${co.maxStaff}). Mejora tu oficina.` };
                    }

                    co.staff.push({
                        role: role,
                        salary: salary,
                        startWage: salary,
                        skill: skill || 0.5,
                        morale: 0.8
                    });
                    return { success: true, message: `Contratado: ${role}` };
                },

                fireStaff(index) {
                    if (!GameState.company) return;
                    GameState.company.staff.splice(index, 1);
                    GameState.company.staff.forEach(s => s.morale = Math.max(0, s.morale - 0.1));
                    return { success: true, message: 'Empleado despedido.' };
                },

                upgradeOffice() {
                    if (!GameState.company) return;
                    const co = GameState.company;

                    let nextLimit = 0;
                    let costMultiplier = 0;

                    if (co.maxStaff === 5) { nextLimit = 10; costMultiplier = 3; }
                    else if (co.maxStaff === 10) { nextLimit = 15; costMultiplier = 3; }
                    else return { success: false, message: 'Ya tienes la oficina m√°xima.' };

                    const baseCost = nextLimit === 10 ? 15000 : 30000;
                    const profitCalc = Math.max(0, co.profitLastMonth) * costMultiplier;
                    const finalCost = Math.max(baseCost, profitCalc);

                    if (co.cash < finalCost) return { success: false, message: `Faltan fondos. Coste: ${formatCurrency(finalCost)}` };

                    co.cash -= finalCost;
                    co.maxStaff = nextLimit;

                    return { success: true, message: `¬°Oficina ampliada! Nuevo l√≠mite: ${nextLimit} empleados.` };
                },

                hireManager() {
                    if (!GameState.company) return;
                    const co = GameState.company;

                    if (co.staff.length < 15 || co.maxStaff < 15) return { success: false, message: 'Necesitas una empresa completa (15 empleados).' };

                    const cost = Math.max(30000, co.profitLastMonth * 3);
                    if (co.cash < cost) return { success: false, message: `Necesitas ${formatCurrency(cost)} para contratar al Gerente y automatizar.` };

                    co.cash -= cost;

                    if (!GameState.ownedCompanies) GameState.ownedCompanies = [];

                    const history = co.financialHistory || [];
                    const last3 = history.slice(-3);
                    let totalProfit = 0;
                    last3.forEach(h => totalProfit += h.profit);

                    let baseline = 0;
                    if (last3.length > 0) {
                        baseline = totalProfit / last3.length;
                    } else {
                        baseline = (co.profitLastMonth || 0) * 0.9;
                    }

                    co.baselineProfit = Math.max(baseline, 500);
                    co.events.push(`üëî Gerente contratado. Ingreso Base fijado en: ${formatCurrency(co.baselineProfit)}`);

                    GameState.ownedCompanies.push(co);

                    GameState.company = null;
                    GameState.jobTitle = 'Magnate (Sin empresa activa)';
                    JobSystem.currentCareerPath = 'none';

                    return { success: true, message: `¬°${co.name} automatizada! Beneficio Base: ${formatCurrency(co.baselineProfit)}/mes.` };
                },

                setStrategicOption(category, value) {
                    if (!GameState.company) return;
                    if (category === 'marketing') GameState.company.marketingChannel = value;
                    if (category === 'provider') GameState.company.providerId = value;
                },

                invest(type) {
                    if (!GameState.company) return;
                    const co = GameState.company;

                    let currentLevel = 1;
                    let name = '';

                    if (type === 'product_dev') { currentLevel = co.productLevel; name = "Desarrollo Producto"; }
                    if (type === 'marketing_infra') { currentLevel = co.marketingLevel; name = "Infraestructura Mkt"; }

                    if (currentLevel >= co.staff.length) {
                        return { success: false, message: `L√≠mite alcanzado: Necesitas m√°s empleados (${co.staff.length}) para mejorar esto.` };
                    }

                    const cost = 5000 * currentLevel;

                    if (co.cash < cost) return { success: false, message: `Necesitas ${formatCurrency(cost)} para mejorar ${name}.` };

                    co.cash -= cost;

                    if (type === 'product_dev') co.productLevel++;
                    if (type === 'marketing_infra') co.marketingLevel++;

                    return { success: true, message: `¬°Mejora completada! ${name} ahora es Nivel ${currentLevel + 1}` };
                },

                sellPassiveCompany(index) {
                    const co = GameState.ownedCompanies[index];
                    if (!co) return;

                    const valuation = Math.floor(co.baselineProfit * 12 * 5);

                    if (confirm(`¬øVender ${co.name} por ${formatCurrency(valuation)}? (5x Beneficio Anual)`)) {
                        GameState.cash += valuation;
                        GameState.ownedCompanies.splice(index, 1);
                        alert(`Has vendido ${co.name}. ${formatCurrency(valuation)} transferidos a tu cuenta personal.`);
                        UI.updateJob(JobSystem);
                    }
                },

                nextTurn() {
                    if (GameState.company) {
                        this.processCompany(GameState.company, true);
                    }

                    if (GameState.ownedCompanies && GameState.ownedCompanies.length > 0) {
                        GameState.ownedCompanies.forEach(co => {
                            this.processCompany(co, false);
                            if (co.profitLastMonth > 0) {
                                GameState.cash += co.profitLastMonth;
                            }
                        });
                    }
                },

                processCompany(co, isActive) {
                    const type = this.businessTypes[co.typeId];

                    // --- PASSIVE LOGIC (Manager) ---
                    if (!isActive) {
                        let volatPct = 0.10;
                        if (co.typeId === 'retail') volatPct = 0.25;
                        if (co.typeId === 'tech') volatPct = 0.50;

                        const variation = (Math.random() * (volatPct * 2)) - volatPct;

                        const base = co.baselineProfit || 1000;
                        const monthlyProfit = Math.floor(base * (1 + variation));

                        co.profitLastMonth = monthlyProfit;
                        co.financialHistory = co.financialHistory || [];

                        co.financialHistory.push({
                            month: GameState.month,
                            revenue: monthlyProfit * 1.5,
                            profit: monthlyProfit,
                            expenses: { total: monthlyProfit * 0.5, wages: 0, rent: 0, cogs: 0, marketing: 0, opex: 0, salary: 0 }
                        });

                        return { profit: monthlyProfit };
                    }

                    // --- ACTIVE LOGIC ---
                    const loc = this.locations[co.locationId];
                    const marketing = this.marketingChannels[co.marketingChannel];
                    const provider = this.providers[co.providerId];

                    co.age++;
                    co.events = [];

                    let totalProductivity = 1.0;
                    let wageBill = 0;

                    co.staff.forEach(emp => {
                        if (emp.skill < 1.0) {
                            const growth = ((Math.random() * 0.04) + 0.01) / 2;
                            emp.skill = Math.min(1.0, emp.skill + growth);
                        } else {
                            // Expert endgame growth bonus
                            const growthRate = (emp.role === 'Experto') ? 0.006 : 0.005;
                            emp.skill += growthRate;
                        }

                        if (!emp.startWage) emp.startWage = emp.salary;

                        const calculationSkill = Math.min(1.0, emp.skill);
                        const wageSteps = Math.floor((calculationSkill - 0.5) / 0.1);
                        const increasePct = wageSteps * 0.10;
                        emp.requiredWage = Math.floor(emp.startWage * (1 + increasePct));

                        if (emp.autoWage) {
                            emp.salary = emp.requiredWage;
                        }

                        if (emp.salary >= emp.requiredWage) {
                            emp.morale = Math.min(1.0, emp.morale + 0.05);
                        } else {
                            emp.morale = Math.max(0.0, emp.morale - 0.10);
                            co.events.push(`‚ö†Ô∏è Empleado descontento: Exige ${formatCurrency(emp.requiredWage)}`);
                        }

                        const contribution = emp.skill * emp.morale;
                        totalProductivity += (contribution);
                        wageBill += emp.salary;
                    });

                    if (!co.organicDemandMult) co.organicDemandMult = 1.0;

                    let growthRate = 0;
                    if (co.reputation >= 2.5) {
                        growthRate = ((co.reputation - 2.5) / 2.5) * 0.05;
                    } else {
                        growthRate = ((co.reputation - 2.5) / 2.5) * 0.03;
                    }

                    co.organicDemandMult *= (1 + growthRate);
                    co.organicDemandMult = Math.max(0.1, co.organicDemandMult);

                    const marketingEffectiveness = marketing.impact * (1 + (co.marketingLevel * 0.2));
                    let demand = (type.baseDemand) * loc.trafficMult * marketingEffectiveness;

                    demand *= (0.5 + (co.reputation / 5));
                    demand *= co.organicDemandMult;

                    const volatility = type.volatility;
                    const fluctuation = 1 + ((Math.random() * volatility * 2) - volatility);
                    demand *= fluctuation;

                    const capacity = Math.floor(totalProductivity * type.productivityPerStaff);
                    const actualCustomers = Math.min(demand, capacity);

                    if (demand > capacity) {
                        co.events.push(`‚ö†Ô∏è Capacidad excedida (${Math.floor(demand)}/${capacity}). Necesitas personal.`);
                    }

                    const baseTicket = type.baseTicket;
                    const sellingPrice = co.customPrice || baseTicket;
                    const avgTicket = sellingPrice;

                    const revenue = actualCustomers * avgTicket;

                    let cogs = revenue * type.cogsPct * provider.priceMod;
                    const opEx = (co.marketingLevel * 100) + (co.productLevel * 150);
                    const rent = 1500 * loc.rentMult;
                    const marketingCost = marketing.cost;

                    let ceoSalary = co.ceoSalary || 0;
                    if (isActive) GameState.salary = ceoSalary;

                    if (co.cash < ceoSalary) ceoSalary = co.cash;
                    if (ceoSalary > 0) GameState.cash += ceoSalary;

                    const totalExpenses = wageBill + rent + cogs + marketingCost + opEx + ceoSalary;
                    const profit = revenue - totalExpenses;

                    co.cash += profit;

                    co.revenueLastMonth = Math.floor(revenue);
                    co.expensesLastMonth = Math.floor(totalExpenses);
                    co.profitLastMonth = Math.floor(profit);

                    const unitCost = avgTicket * type.cogsPct * provider.priceMod;
                    const prevDemand = co.lastStats ? co.lastStats.demand : 0;
                    let growthPct = 0;

                    if (prevDemand > 0) {
                        growthPct = ((Math.floor(demand) - prevDemand) / prevDemand);
                    }

                    co.lastStats = {
                        ticket: avgTicket,
                        unitCost: unitCost,
                        unitMargin: avgTicket - unitCost,
                        demand: Math.floor(demand),
                        demandGrowth: growthPct,
                        capacity: Math.floor(capacity),
                        customers: Math.floor(actualCustomers),
                        productivityPerStaff: type.productivityPerStaff,
                        totalProductivity: totalProductivity,
                        demandComposition: {
                            base: type.baseDemand,
                            traffic: loc.trafficMult,
                            marketing: marketingEffectiveness,
                            reputation: (0.5 + (co.reputation / 5)),
                            organic: co.organicDemandMult,
                            volatility: fluctuation
                        }
                    };

                    const historyEntry = {
                        month: co.age,
                        revenue: co.revenueLastMonth,
                        profit: co.profitLastMonth,
                        expenses: {
                            wages: Math.floor(wageBill),
                            rent: Math.floor(rent),
                            cogs: Math.floor(cogs),
                            marketing: Math.floor(marketingCost),
                            opex: Math.floor(opEx),
                            salary: Math.floor(ceoSalary),
                            total: co.expensesLastMonth
                        }
                    };

                    if (!co.financialHistory) co.financialHistory = [];
                    co.financialHistory.push(historyEntry);
                    if (co.financialHistory.length > 24) co.financialHistory.shift();

                    if (!co.revenueHistory) co.revenueHistory = [];
                    if (!co.profitHistory) co.profitHistory = [];
                    co.revenueHistory.push(co.revenueLastMonth);
                    co.profitHistory.push(co.profitLastMonth);
                    if (co.revenueHistory.length > 24) co.revenueHistory.shift();
                    if (co.profitHistory.length > 24) co.profitHistory.shift();

                    const actualQuality = provider.quality + ((co.productLevel - 1) * 0.05);
                    const priceRatio = (avgTicket / baseTicket) || 1;
                    const priceChangePct = priceRatio - 1;
                    const requiredQuality = 0.70 + (priceChangePct * 2.0);

                    const qualityGap = actualQuality - requiredQuality;

                    let targetRep = 3.5 + (qualityGap * 5);
                    targetRep = Math.min(5, Math.max(0, targetRep));

                    const change = (targetRep - co.reputation) * 0.1;
                    const repBefore = co.reputation;
                    co.reputation = Math.min(5, Math.max(0, co.reputation + change));
                    const repGrowthPct = repBefore > 0 ? (co.reputation - repBefore) / repBefore : 0;

                    if (co.lastStats) {
                        co.lastStats.actualQuality = actualQuality;
                        co.lastStats.requiredQuality = requiredQuality;
                        co.lastStats.targetRep = targetRep;
                        co.lastStats.repGrowth = repGrowthPct;
                        co.lastStats.currentRep = co.reputation;
                    }

                    if (Math.random() > provider.reliability) {
                        const lost = Math.floor(revenue * 0.2);
                        co.revenueLastMonth -= lost;
                        co.cash -= lost;
                        co.events.push(`üìâ Problema de suministros. Ventas afectadas.`);
                    }

                    if (co.cash < -10000) {
                        co.events.push("‚õî ¬°PELIGRO! Caja muy negativa.");
                    }

                    return { revenue: co.revenueLastMonth, profit: co.profitLastMonth };
                },

                withdraw(amount) {
                    if (!GameState.company) return;
                    if (GameState.company.cash < amount) return { success: false, message: 'No hay suficiente caja.' };
                    GameState.company.cash -= amount;
                    GameState.cash += amount;
                    return { success: true, message: `Retirados ${formatCurrency(amount)}.` };
                },

                deposit(amount) {
                    if (!GameState.company) return;
                    if (GameState.cash < amount) return { success: false, message: 'No tienes suficiente efectivo personal.' };
                    GameState.cash -= amount;
                    GameState.company.cash += amount;
                    return { success: true, message: `Inyectados ${formatCurrency(amount)}.` };
                },

                sellCompany() {
                    if (!GameState.company) return;
                    const co = GameState.company;

                    let annualProfit = 0;
                    if (co.financialHistory && co.financialHistory.length > 0) {
                        const last12 = co.financialHistory.slice(-12);
                        annualProfit = last12.reduce((sum, m) => sum + m.profit, 0);
                    } else {
                        annualProfit = co.profitLastMonth * 12;
                    }

                    if (annualProfit < 0) annualProfit = 0;

                    let upgradeMult = 1;
                    if (co.maxStaff >= 10) upgradeMult *= 2;
                    if (co.maxStaff >= 15) upgradeMult *= 2;

                    const valuation = Math.floor(annualProfit * upgradeMult);
                    const liquidationCash = co.cash;
                    const totalExit = valuation + liquidationCash;

                    if (!confirm(`OFERTA DE COMPRA\n\nBeneficio Anual: ${formatCurrency(annualProfit)}\nMultiplicador Mejoras: x${upgradeMult}\n\nValoraci√≥n: ${formatCurrency(valuation)}\nCaja Actual: ${formatCurrency(liquidationCash)}\n\nTOTAL OPERACI√ìN: ${formatCurrency(totalExit)}\n\n¬øVender empresa y salir?`)) return;

                    GameState.cash += totalExit;
                    GameState.company = null;
                    GameState.jobTitle = 'Ex-Fundador (Desempleado)';
                    GameState.salary = 0;
                    JobSystem.currentCareerPath = 'none';

                    return { success: true, message: `¬°EXITO! Empresa vendida por ${formatCurrency(totalExit)}.` };
                }
            };

            /*******************************************************
             * JOB SYSTEM
             *******************************************************/
            const JobSystem = {
                careers: {
                    'comercio': [
                        { title: 'Reponedor', salary: 1100, reqMonths: 0, reqEdu: null },
                        { title: 'Cajero', salary: 1300, reqMonths: 6, reqEdu: null },
                        { title: 'Encargado de Tienda', salary: 1800, reqMonths: 24, reqEdu: 'FP' },
                        { title: 'Gerente Regional', salary: 3500, reqMonths: 60, reqEdu: 'Carrera' }
                    ],
                    'tech': [
                        { title: 'Becario IT', salary: 800, reqMonths: 0, reqEdu: 'FP' },
                        { title: 'Junior Dev', salary: 1800, reqMonths: 6, reqEdu: 'FP' },
                        { title: 'Senior Dev', salary: 3200, reqMonths: 36, reqEdu: 'Carrera' },
                        { title: 'CTO', salary: 6000, reqMonths: 96, reqEdu: 'Master' }
                    ]
                },
                currentCareerPath: 'comercio',
                monthsInCurrentJob: 0,

                nextTurn() {
                    if (GameState.company) {
                        return;
                    }

                    if (!GameState.isStudying) {
                        this.monthsInCurrentJob++;
                    } else {
                        this.monthsInCurrentJob += 0.5;
                    }
                },

                getAvailablePromotions() {
                    if (this.currentCareerPath === 'entrepreneur' || this.currentCareerPath === 'none') return null;

                    const path = this.careers[this.currentCareerPath];
                    const currentJobIndex = path.findIndex(j => j.title === GameState.jobTitle);

                    if (currentJobIndex === -1 || currentJobIndex >= path.length - 1) return null;
                    const nextJob = path[currentJobIndex + 1];
                    return nextJob;
                },

                promote() {
                    const nextJob = this.getAvailablePromotions();
                    if (!nextJob) return { success: false, message: 'No hay ascensos disponibles.' };

                    if (Math.floor(this.monthsInCurrentJob) < nextJob.reqMonths) {
                        return { success: false, message: `Faltan ${(nextJob.reqMonths - this.monthsInCurrentJob).toFixed(1)} meses de experiencia.` };
                    }

                    if (nextJob.reqEdu) {
                        if (!this.checkEducation(nextJob.reqEdu)) return { success: false, message: `Necesitas estudios de tipo: ${nextJob.reqEdu}` };
                    }

                    GameState.salary = nextJob.salary;
                    GameState.jobTitle = nextJob.title;
                    this.monthsInCurrentJob = 0;
                    return { success: true, message: `¬°Ascendido a ${nextJob.title}! Nuevo salario base: ${nextJob.salary}‚Ç¨` };
                },

                checkEducation(req) {
                    return GameState.education.some(e => {
                        if (req === 'FP') return e.includes('FP') || e.includes('Grado') || e.includes('Ingenier√≠a');
                        if (req === 'Carrera') return e.includes('Grado') || e.includes('Ingenier√≠a');
                        if (req === 'Master') return e.includes('MBA') || e.includes('Master');
                        return false;
                    });
                },

                getAllVacancies() {
                    const allJobs = [];
                    for (const [pathKey, jobs] of Object.entries(this.careers)) {
                        jobs.forEach(job => {
                            if (job.title === GameState.jobTitle) return;
                            allJobs.push({ ...job, path: pathKey });
                        });
                    }
                    return allJobs;
                },

                applyToJob(jobTitle) {
                    let targetJob, targetPath;
                    for (const [pathKey, jobs] of Object.entries(this.careers)) {
                        const found = jobs.find(j => j.title === jobTitle);
                        if (found) {
                            targetJob = found;
                            targetPath = pathKey;
                            break;
                        }
                    }

                    if (!targetJob) return { success: false, message: 'Oferta no v√°lida.' };
                    if (targetJob.reqEdu && !this.checkEducation(targetJob.reqEdu)) {
                        return { success: false, message: `Requisito acad√©mico no cumplido: ${targetJob.reqEdu}` };
                    }

                    if (GameState.company) {
                        if (!confirm('Al aceptar este trabajo cerrar√°s tu empresa. ¬øSeguro?')) return { success: false, message: 'Operaci√≥n cancelada' };
                        GameState.company = null;
                    }

                    this.switchJobEnhanced(targetPath, targetJob);
                    return { success: true, message: `¬°Contratado como ${targetJob.title}!` };
                },

                switchJobEnhanced(pathKey, jobObj) {
                    this.currentCareerPath = pathKey;
                    GameState.jobTitle = jobObj.title;
                    GameState.salary = jobObj.salary;
                    this.monthsInCurrentJob = 0;
                }
            };

            /*******************************************************
             * UI
             *******************************************************/
            const formatCurrency = (amount) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(amount);
            const formatPercent = (val) => (val * 100).toFixed(2) + '%';

            const UI = {
                chartTimeframe: 24, // Default 2 years
                stockChartTimeframe: 24,
                currentOpenStock: null,
                updateHeader() {
                    // Update Date
                    document.getElementById('date-display').textContent = `Mes: ${GameState.month} | A√±o: ${GameState.year}`;

                    // Update Money
                    document.getElementById('money-display').textContent = formatCurrency(GameState.cash);

                    // Update Player Name
                    const pName = document.getElementById('header-player-name');
                    if (pName) {
                        pName.textContent = GameState.playerName || 'Jugador';
                    }
                },
                updateDashboard() {
                    const nw = updateNetWorth();

                    // DATA PREP
                    let cash = GameState.cash;
                    let stocksVal = 0;
                    GameState.inventory.stocks.forEach(s => {
                        const st = StockMarket.getStock(s.symbol);
                        stocksVal += s.quantity * (st ? st.price : s.avgPrice);
                    });

                    let reValue = 0;
                    let reMortgage = 0;
                    GameState.inventory.realEstate.forEach(p => reValue += p.price);
                    GameState.loans.forEach(l => {
                        if (l.type === 'Hipotecario') reMortgage += l.remainingBalance;
                    });
                    let reEquity = reValue - reMortgage;

                    let rentIncome = GameState.inventory.realEstate.reduce((acc, p) => acc + p.monthlyRent, 0);
                    let holdingIncome = (GameState.ownedCompanies || []).reduce((acc, c) => acc + (c.baselineProfit || 0), 0);
                    // Also add active company profit if receiving salary/dividends or just raw profit?
                    // Request says "beneficio mes", usually implies net profit of the company.
                    if (GameState.company) {
                        holdingIncome += (GameState.company.profitLastMonth || 0);
                    }

                    let loanInterests = 0;
                    GameState.loans.forEach(l => { loanInterests += (l.remainingBalance * l.interestRate / 12); });

                    const totalIncome = GameState.salary + rentIncome + holdingIncome;
                    const totalExpenses = GameState.expenses + loanInterests;
                    const monthlyFlow = totalIncome - totalExpenses;

                    let companyCount = (GameState.company ? 1 : 0) + (GameState.ownedCompanies ? GameState.ownedCompanies.length : 0);
                    // holdingIncome is already calculated above as sum of profits

                    // DOM UPDATE
                    const container = document.getElementById('dashboard-view');
                    if (!container) return;

                    // Clear existing to rebuild
                    container.innerHTML = `
        <div class="dashboard-container">
            <div class="section-header">
                <h2>Resumen Ejecutivo</h2>
                <span style="color:#94a3b8; font-size:0.9rem;">Edad: ${GameState.age} a√±os | Mes: ${GameState.month}</span>
            </div>

            <!-- KPI ROW -->
            <div class="summary-kpi-row" style="grid-template-columns: 1fr 1fr;">
                <div class="kpi-box" style="border-bottom: 2px solid #facc15;">
                    <div class="kpi-label">Patrimonio Neto</div>
                    <div class="kpi-value" style="color:#facc15">${formatCurrency(nw)}</div>
                </div>
                <div class="kpi-box" style="border-bottom: 2px solid #38bdf8;">
                    <div class="kpi-label">Flujo Mensual</div>
                    <div class="kpi-value" style="color:${monthlyFlow >= 0 ? '#38bdf8' : '#f87171'}">${monthlyFlow >= 0 ? '+' : ''}${formatCurrency(monthlyFlow)}</div>
                    <div class="kpi-sub">Ing: ${formatCurrency(totalIncome)} | Gas: ${formatCurrency(totalExpenses)}</div>
                </div>
            </div>

            <!-- ASSET BREAKDOWN -->
            <div class="dashboard-grid">
                <div class="dashboard-card">

                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #334155; margin-bottom:15px; padding-bottom:10px;">
                        <h3 style="margin:0; color:#cbd5e1; font-size:1.1rem;">üìà Evoluci√≥n</h3>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-filter ${UI.chartTimeframe === 6 ? 'active' : ''}" onclick="UI.chartTimeframe=6; UI.updateDashboard()">6M</button>
                            <button class="btn-filter ${UI.chartTimeframe === 24 ? 'active' : ''}" onclick="UI.chartTimeframe=24; UI.updateDashboard()">2A</button>
                            <button class="btn-filter ${UI.chartTimeframe === 999 ? 'active' : ''}" onclick="UI.chartTimeframe=999; UI.updateDashboard()">MAX</button>
                        </div>
                    </div>
                    <div style="height:300px; width:100%;">
                        <canvas id="net-worth-chart"></canvas>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3 style="margin-top:0; color:#cbd5e1; font-size:1.1rem; margin-bottom:15px; border-bottom:1px solid #334155; padding-bottom:10px;">üìä Desglose de Activos</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                        <div>
                            <div style="font-size:0.8rem; color:#94a3b8;">Liquidez (Caja)</div>
                            <div style="font-size:1.1rem; font-weight:bold; color:#4ade80;">${formatCurrency(cash)}</div>
                        </div>
                        <div>
                            <div style="font-size:0.8rem; color:#94a3b8;">Bolsa</div>
                            <div style="font-size:1.1rem; font-weight:bold;">${formatCurrency(stocksVal)}</div>
                        </div>
                        <div>
                            <div style="font-size:0.8rem; color:#94a3b8;">Inmobiliario (Neto)</div>
                            <div style="font-size:1.1rem; font-weight:bold;">${formatCurrency(reEquity)}</div>
                        </div>
                        <div>
                            <div style="font-size:0.8rem; color:#94a3b8;">Empresas</div>
                            <div style="font-size:1.1rem; font-weight:bold;">${companyCount}</div> 
                        </div>
                    </div>
                    <div style="border-top:1px dashed #334155; padding-top:10px;">
                        <div style="font-size:0.8rem; color:#94a3b8;">Beneficio Empresas</div>
                        <div style="font-size:1rem; font-weight:bold; color:${holdingIncome >= 0 ? '#4ade80' : '#f87171'}">${formatCurrency(holdingIncome)}/mes</div>
                    </div>
                </div>
            </div>
        </div>
    `;

                    // Re-draw chart (Filtered)
                    const h = GameState.history;
                    const limit = UI.chartTimeframe;
                    const slicedHistory = {
                        labels: h.labels.slice(-limit),
                        netWorth: h.netWorth.slice(-limit),
                        cash: h.cash.slice(-limit),
                        debt: h.debt.slice(-limit)
                    };
                    ChartModule.drawChart('net-worth-chart', slicedHistory);
                },
                updateMarket() {
                    const container = document.getElementById('market-view');
                    if (!container) return;

                    // DATA
                    const stocks = StockMarket.stocks;
                    const portfolio = GameState.inventory.stocks;

                    // CALCS
                    let portValue = 0;
                    let costBasis = 0;
                    portfolio.forEach(p => {
                        const s = StockMarket.getStock(p.symbol);
                        if (s) {
                            portValue += p.quantity * s.price;
                            costBasis += p.quantity * p.avgPrice;
                        }
                    });
                    const totalReturn = portValue - costBasis;
                    const returnDir = totalReturn >= 0 ? '+' : '';
                    const returnClass = totalReturn >= 0 ? '#4ade80' : '#f87171';

                    // RENDER
                    container.innerHTML = `
                    <div class="dashboard-container">
                        <div class="section-header">
                            <h2>Mercado de Valores</h2>
                            <span style="color:#94a3b8; font-size:0.9rem;">IBEX 35</span>
                        </div>

                        <!-- MARKET HERO -->
                        <div class="market-hero">
                            <div>
                                <div style="font-size:0.8rem; color:#94a3b8; text-transform:uppercase;">Valor Cartera</div>
                                <div style="font-size:1.5rem; font-weight:bold; color:#fff;">${formatCurrency(portValue)}</div>
                            </div>
                            <div>
                                <div style="font-size:0.8rem; color:#94a3b8; text-transform:uppercase;">Retorno Total</div>
                                <div style="font-size:1.5rem; font-weight:bold; color:${returnClass}">${returnDir}${formatCurrency(totalReturn)}</div>
                            </div>
                             <div>
                                <div style="font-size:0.8rem; color:#94a3b8; text-transform:uppercase;">Rentabilidad</div>
                                <div style="font-size:1.5rem; font-weight:bold; color:${returnClass}">${costBasis > 0 ? (totalReturn / costBasis * 100).toFixed(2) : '0.00'}%</div>
                            </div>
                        </div>

                        <!-- TICKER TAPE / GRID -->
                        <div class="job-section-spacer">
                            <h3 style="color:#cbd5e1; margin-bottom:15px;">üìä Cotizaciones (Click para Operar)</h3>
                            <div class="market-grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                                ${stocks.map(stock => {
                        const trendClass = stock.trend >= 0 ? 'rising' : 'falling';
                        const trendColor = stock.trend >= 0 ? '#4ade80' : '#f87171';
                        const sign = stock.trend >= 0 ? '+' : '';
                        return `
                                    <div class="stock-chip ${trendClass}" data-symbol="${stock.symbol}">
                                        <div>
                                            <div style="font-weight:bold; font-size:1.1rem;">${stock.symbol}</div>
                                            <div style="font-size:0.8rem; color:#94a3b8;">${stock.name}</div>
                                        </div>
                                        <div style="text-align:right;">
                                            <div style="font-weight:bold;">${formatCurrency(stock.price)}</div>
                                            <div style="font-size:0.8rem; color:${trendColor};">${sign}${(stock.trend * 100).toFixed(2)}%</div>
                                        </div>
                                    </div>
                                    `;
                    }).join('')}
                            </div>
                        </div>

                        <!-- POSITIONS TABLE -->
                         <div class="dashboard-card">
                            <h3 style="margin-top:0; color:#cbd5e1; margin-bottom:15px; border-bottom:1px solid #334155; padding-bottom:10px;">üíº Mis Posiciones</h3>
                            ${portfolio.length === 0 ? '<p style="color:#64748b;">No hay posiciones abiertas.</p>' :
                            `<table style="width:100%; text-align:left; font-size:0.9rem; border-collapse:collapse;">
                            <tr style="color:#94a3b8; border-bottom:1px solid #334155;">
                                <th style="padding:10px 0;">Ticker</th>
                                <th>Cant.</th>
                                <th>Media</th>
                                <th>Valor</th>
                                <th style="text-align:right;">P&L</th>
                                <th style="text-align:right;">Acci√≥n</th>
                            </tr>
                            ${portfolio.map(p => {
                                const s = StockMarket.getStock(p.symbol);
                                if (!s) return '';
                                const val = p.quantity * s.price;
                                const pl = val - (p.quantity * p.avgPrice);
                                const plColor = pl >= 0 ? '#4ade80' : '#f87171';
                                return `
                                    <tr style="border-bottom:1px solid #1e293b;">
                                        <td style="padding:10px 0; font-weight:bold;">${p.symbol}</td>
                                        <td>${p.quantity}</td>
                                        <td>${formatCurrency(p.avgPrice)}</td>
                                        <td>${formatCurrency(val)}</td>
                                        <td style="text-align:right; color:${plColor}; font-weight:bold;">${pl >= 0 ? '+' : ''}${formatCurrency(pl)}</td>
                                         <td style="text-align:right;">
                                            <button onclick="UI.openStockModal(StockMarket.getStock('${p.symbol}'))" style="background:#dc2626; color:white; border:none; padding:2px 6px; border-radius:4px; cursor:pointer; font-size:0.7rem;">VENDER</button>
                                        </td>
                                    </tr>
                                    `;
                            }).join('')}
                        </table>`
                        }
                        </div>
                    </div>
                `;

                    // EVENTS
                    container.querySelectorAll('.stock-chip').forEach(chip => {
                        chip.onclick = () => {
                            const symbol = chip.dataset.symbol;
                            const stock = StockMarket.getStock(symbol);
                            if (stock) UI.openStockModal(stock);
                        };
                    });
                },

                openStockModal(stock) {
                    const portfolioItem = GameState.inventory.stocks.find(s => s.symbol === stock.symbol);
                    const owned = portfolioItem ? portfolioItem.quantity : 0;
                    const avg = portfolioItem ? portfolioItem.avgPrice : 0;

                    const msg = `
                 <div style="margin-bottom:15px; background:#0f172a; padding:10px; border-radius:6px;">
                     <!-- CHART HEADER -->
                     <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div style="font-weight:bold; color:#fff;">
                            ${stock.name} 
                            <span id="chart-roi-display" style="font-size:0.8rem; margin-left:10px; padding:2px 6px; border-radius:4px;"></span>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-filter ${UI.stockChartTimeframe === 6 ? 'active' : ''}" onclick="UI.stockChartTimeframe=6; UI.updateStockModalChart()">6M</button>
                            <button class="btn-filter ${UI.stockChartTimeframe === 24 ? 'active' : ''}" onclick="UI.stockChartTimeframe=24; UI.updateStockModalChart()">2A</button>
                            <button class="btn-filter ${UI.stockChartTimeframe === 999 ? 'active' : ''}" onclick="UI.stockChartTimeframe=999; UI.updateStockModalChart()">MAX</button>
                        </div>
                     </div>
                     
                     <!-- CHART CANAVS -->
                     <div style="height:150px; width:100%; margin-bottom:10px;">
                        <canvas id="stock-modal-chart"></canvas>
                     </div>

                     <div style="display:flex; justify-content:space-between; align-items:end;">
                        <div style="font-size:1.5rem; color:${stock.trend >= 0 ? '#4ade80' : '#f87171'}">${formatCurrency(stock.price)}</div>
                        <div style="font-size:0.9rem; color:#94a3b8;">Tendencia: ${(stock.trend * 100).toFixed(2)}%</div>
                     </div>
                 </div>
                 <div style="margin-bottom:15px;">
                     <p>En Cartera: <strong>${owned}</strong> acciones</p>
                     <p>Valor de Mercado: <strong>${formatCurrency(owned * stock.price)}</strong></p>
                 </div>
                 <div style="display:flex; flex-direction:column; gap:10px;">
                     <input type="number" id="stock-action-qty" placeholder="Cantidad" style="padding:10px; background:#1e293b; border:1px solid #475569; color:white; border-radius:6px;">
                 </div>
                 `;

                    this.showModal('Operar en Bolsa', msg, [
                        {
                            text: 'Comprar', style: 'success', fn: () => {
                                const qty = parseInt(document.getElementById('stock-action-qty').value);
                                if (!qty || qty <= 0) return alert('Cantidad inv√°lida');
                                const res = StockMarket.buyStock(stock.symbol, qty);
                                if (res.success) {
                                    alert(res.message);
                                    UI.updateHeader();
                                    UI.updateDashboard();
                                    UI.updateMarket();
                                } else {
                                    alert(res.message);
                                }
                            }
                        },
                        {
                            text: 'Vender', style: 'danger', fn: () => {
                                const qty = parseInt(document.getElementById('stock-action-qty').value);
                                if (!qty || qty <= 0) return alert('Cantidad inv√°lida');
                                if (owned < qty) return alert('No tienes suficientes acciones');

                                const res = StockMarket.sellStock(stock.symbol, qty);
                                if (res.success) {
                                    alert(res.message);
                                    UI.updateHeader();
                                    UI.updateDashboard();
                                    UI.updateMarket();
                                } else {
                                    alert(res.message);
                                }
                            }
                        },
                        { text: 'Cancelar', style: 'secondary', fn: null }
                    ]);

                    // Init Chart
                    UI.currentOpenStock = stock;
                    UI.stockChartTimeframe = 24;
                    setTimeout(() => UI.updateStockModalChart(), 100);
                },

                updateStockModalChart() {
                    if (!UI.currentOpenStock) return;
                    ChartModule.drawStockChart('stock-modal-chart', UI.currentOpenStock, UI.stockChartTimeframe);

                    // Calculate ROI for timeframe
                    const h = UI.currentOpenStock.history || [];
                    let roi = 0;
                    let subset = h;

                    if (UI.stockChartTimeframe !== 999) {
                        subset = h.slice(-UI.stockChartTimeframe);
                    }

                    if (subset.length > 0) {
                        const start = subset[0];
                        const end = subset[subset.length - 1];
                        if (start > 0) roi = (end - start) / start;
                    }

                    // Update ROI Display
                    const roiEl = document.getElementById('chart-roi-display');
                    if (roiEl) {
                        const sign = roi >= 0 ? '+' : '';
                        const color = roi >= 0 ? '#4ade80' : '#f87171';
                        const bg = roi >= 0 ? 'rgba(74, 222, 128, 0.2)' : 'rgba(248, 113, 113, 0.2)';
                        roiEl.textContent = `${sign}${(roi * 100).toFixed(2)}%`;
                        roiEl.style.color = color;
                        roiEl.style.backgroundColor = bg;
                    }

                    // Update button styles (hacky DOM update for modal buttons)
                    const btns = document.querySelectorAll('#modal-content .btn-filter');
                    btns.forEach(b => {
                        b.classList.remove('active');
                        if (b.innerText === '6M' && UI.stockChartTimeframe === 6) b.classList.add('active');
                        if (b.innerText === '2A' && UI.stockChartTimeframe === 24) b.classList.add('active');
                        if (b.innerText === 'MAX' && UI.stockChartTimeframe === 999) b.classList.add('active');
                    });
                },
                updateBank(BankModule) {
                    const container = document.getElementById('bank-view');
                    if (!container) return;

                    // DATA
                    const limit = BankModule.getMaxLoanAmount();
                    const loans = GameState.loans;

                    // RENDER
                    container.innerHTML = `
                    <div class="dashboard-container">
                         <div class="section-header">
                            <h2>Banco Central</h2>
                            <span style="color:#94a3b8; font-size:0.9rem;">L√≠mite Cr√©dito: ${formatCurrency(limit)}</span>
                        </div>

                        <div class="bank-grid">
                            <!-- LEFT: CALCULATOR -->
                            <div class="calculator-card">
                                <h3 style="margin-top:0; color:#facc15; border-bottom:1px solid #334155; padding-bottom:10px; margin-bottom:20px;">üí∞ Solicitar Financiaci√≥n</h3>
                                
                                <div class="loan-input-group">
                                    <label>Cantidad a solicitar (‚Ç¨)</label>
                                    <input type="number" id="loan-amount-input" class="loan-input" placeholder="Ej. 50000" min="1000" step="1000">
                                </div>
                                <div class="loan-input-group">
                                    <label>Plazo de Amortizaci√≥n: <span id="loan-years-val" style="color:white; font-weight:bold;">2 a√±os</span></label>
                                    <input type="range" id="loan-years-input" min="1" max="5" value="2" style="width:100%; accent-color:#facc15;">
                                </div>

                                <div class="loan-summary">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                        <span>Tipo de Inter√©s</span>
                                        <span style="color:#f87171; font-weight:bold;">12.0% TAE</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; font-size:1.1rem; border-top:1px solid #334155; padding-top:5px; margin-top:5px;">
                                        <span>Cuota Mensual</span>
                                        <span id="loan-monthly-preview" style="color:#facc15; font-weight:bold;">0,00 ‚Ç¨</span>
                                    </div>
                                </div>

                                <button id="btn-request-loan-dynamic" class="btn-action-primary" style="background:#facc15; color:#0f172a; margin-top:20px;">Solicitar Pr√©stamo</button>
                            </div>

                            <!-- RIGHT: ACTIVE LOANS -->
                            <div>
                                <h3 style="margin-top:0; color:#94a3b8; margin-bottom:20px;">Pr√©stamos Activos (${loans.length})</h3>
                                <div id="active-loans-wrapper">
                                    ${loans.length === 0 ?
                            '<p style="color:#64748b; font-style:italic; border:1px dashed #334155; padding:20px; border-radius:8px; text-align:center;">No tienes deudas activas. ¬°Buen trabajo!</p>' :
                            loans.map(loan => {
                                const progress = ((loan.termMonths - loan.remainingMonths) / loan.termMonths) * 100;
                                return `
                                            <div class="active-loan-card">
                                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                                    <strong style="color:#fff; font-size:1.1rem;">${loan.type}</strong>
                                                    <span style="background:rgba(239, 68, 68, 0.2); color:#f87171; padding:2px 8px; border-radius:4px; font-size:0.8rem;">-${formatCurrency(loan.remainingBalance)}</span>
                                                </div>
                                                <div style="display:flex; justify-content:space-between; font-size:0.9rem; color:#cbd5e1;">
                                                    <span>Cuota: ${formatCurrency(loan.monthlyPayment)}</span>
                                                    <span>Restan: ${loan.remainingMonths} meses</span>
                                                </div>
                                                <div class="loan-progress">
                                                    <div class="loan-bar" style="width:${progress}%"></div>
                                                </div>
                                                ${loan.type !== 'Hipotecario' ?
                                        `<button class="btn-pay-all-dynamic" data-id="${loan.id}" style="width:100%; background:transparent; border:1px solid #ef4444; color:#ef4444; padding:5px; border-radius:4px; cursor:pointer; font-size:0.8rem; margin-top:5px;">Amortizar Todo</button>`
                                        : ''}
                                            </div>
                                            `;
                            }).join('')
                        }
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                    // EVENTS
                    const amountIn = document.getElementById('loan-amount-input');
                    const yearsIn = document.getElementById('loan-years-input');
                    const yearsVal = document.getElementById('loan-years-val');
                    const monthlyPrev = document.getElementById('loan-monthly-preview');
                    const btnReq = document.getElementById('btn-request-loan-dynamic');

                    const updateCalc = () => {
                        const amount = parseFloat(amountIn.value) || 0;
                        const years = parseInt(yearsIn.value);
                        yearsVal.textContent = `${years} a√±os`;
                        if (amount > 0) {
                            // Formula copy from Bank.takeLoan logic for preview
                            const r = 0.12 / 12;
                            const n = years * 12;
                            const pmt = (amount * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
                            monthlyPrev.textContent = formatCurrency(pmt);
                        } else {
                            monthlyPrev.textContent = "0,00 ‚Ç¨";
                        }
                    };

                    amountIn.addEventListener('input', updateCalc);
                    yearsIn.addEventListener('input', updateCalc);

                    btnReq.addEventListener('click', () => {
                        const amount = parseFloat(amountIn.value);
                        const years = parseInt(yearsIn.value);
                        if (!amount || amount <= 0) return alert("Introduce una cantidad v√°lida.");

                        const res = BankModule.takeLoan(amount, years);
                        alert(res.message);
                        if (res.success) {
                            UI.updateHeader();
                            UI.updateDashboard(); // Reflow cash
                            UI.updateBank(BankModule);
                        }
                    });

                    container.querySelectorAll('.btn-pay-all-dynamic').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = e.target.dataset.id;
                            if (confirm('¬øPagar todo el pr√©stamo restante?')) {
                                const res = BankModule.payLoanTotally(id); // Ensure this method allows passing ID or check logic
                                // Actually Bank module might need strict ID matching.
                                // Let's assume payLoanTotally logic handles string/number conversion if needed.
                                // Wait, Bank.payLoanTotally iterates loans. ID is timestamp (number).
                                // dataset is string. Need parseInt.

                                // Small inline logic fix:
                            }
                        });
                    });

                    // Re-bind properly with ID parsing because dataset is always string
                    container.querySelectorAll('.btn-pay-all-dynamic').forEach(btn => {
                        btn.onclick = (e) => {
                            const id = parseInt(e.target.dataset.id); // Parse ID!
                            const res = BankModule.payLoanTotally(id);
                            alert(res.message);
                            if (res.success) {
                                UI.updateHeader();
                                UI.updateDashboard();
                                UI.updateBank(BankModule);
                            }
                        };
                    });
                },
                updateRealEstate(REModule) {
                    const container = document.getElementById('real-estate-view');
                    if (!container) return;

                    // DATA
                    const properties = REModule.availableProperties;
                    const owned = GameState.inventory.realEstate;

                    // Stats for Hero
                    let totalVal = 0;
                    let totalRent = 0;
                    let totalEquity = 0;

                    owned.forEach(p => {
                        totalVal += p.price;
                        totalRent += p.monthlyRent;
                    });
                    // Simple equity approximation (Value - Mortgages)
                    // We need to check loans for mortgages
                    let mortgageDebt = 0;
                    GameState.loans.forEach(l => { if (l.type === 'Hipotecario') mortgageDebt += l.remainingBalance; });
                    totalEquity = totalVal - mortgageDebt;

                    // RENDER
                    container.innerHTML = `
                    <div class="dashboard-container">
                        <div class="section-header">
                            <h2>Bienes Inmobiliarios</h2>
                            <span style="color:#94a3b8; font-size:0.9rem;">Propiedades: ${owned.length}</span>
                        </div>

                        <!-- HERO STATS -->
                        <div class="portfolio-hero">
                            <div class="portfolio-stat">
                                <span class="label">Valor Cartera</span>
                                <span class="value">${formatCurrency(totalVal)}</span>
                            </div>
                            <div class="portfolio-stat">
                                <span class="label">Patrimonio (Equity)</span>
                                <span class="value">${formatCurrency(totalEquity)}</span>
                            </div>
                             <div class="portfolio-stat">
                                <span class="label">Rentas / mes</span>
                                <span class="value" style="color:#a7f3d0">+${formatCurrency(totalRent)}</span>
                            </div>
                        </div>

                        <!-- MARKET -->
                        <div class="job-section-spacer">
                            <h3 style="color:#cbd5e1; margin-bottom:20px;">üèôÔ∏è Mercado Inmobiliario</h3>
                            <div class="market-grid">
                                ${properties.map(prop => {
                        const pricePerM2 = prop.price / prop.sizeM2;
                        const isGoodDeal = pricePerM2 < prop.zoneAvgPrice;
                        const dealText = isGoodDeal ? 'Chollo' : 'Sobreprecio';
                        const dealClass = isGoodDeal ? 'good-deal' : 'bad-deal';
                        const roi = (prop.monthlyRent * 12) / prop.price;

                        return `
                                    <div class="property-card-expert">
                                        <div class="prop-img">
                                            üè¢
                                            <span class="deal-badge ${dealClass}">${dealText}</span>
                                        </div>
                                        <div class="prop-content">
                                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                                <h4 style="margin:0; font-size:1.1rem; color:#fff;">${prop.name}</h4>
                                                <span style="font-size:0.8rem; color:#94a3b8;">${prop.sizeM2} m¬≤</span>
                                            </div>
                                            <p class="prop-price-large">${formatCurrency(prop.price)}</p>
                                            
                                            <div class="prop-details-grid">
                                                <div>Alquiler: ${formatCurrency(prop.monthlyRent)}</div>
                                                <div class="prop-roi">ROI: ${(roi * 100).toFixed(1)}%</div>
                                                <div>Zona: ${formatCurrency(prop.zoneAvgPrice)}/m¬≤</div>
                                                <div>Entrada: ${formatCurrency(prop.price * prop.downPaymentPct)}</div>
                                            </div>

                                            <button class="btn-buy-prop-dynamic btn-action-primary" data-id="${prop.id}" style="margin-top:auto;">
                                                Comprar (Entrada)
                                            </button>
                                        </div>
                                    </div>
                                    `;
                    }).join('')}
                            </div>
                        </div>

                        <!-- OWNED -->
                        <div class="dashboard-card">
                            <h3 style="margin-top:0; color:#cbd5e1; margin-bottom:15px; border-bottom:1px solid #334155; padding-bottom:10px;">üîë Mis Propiedades</h3>
                             ${owned.length === 0 ? '<p style="color:#64748b;">No tienes propiedades en cartera.</p>' :
                            '<div style="display:grid; gap:10px;">' +
                            owned.map(prop => {
                                const purchasePrice = prop.purchasePrice || prop.price; // Fallback
                                const diff = prop.price - purchasePrice;
                                const pct = ((diff / purchasePrice) * 100).toFixed(2);
                                const color = diff >= 0 ? '#4ade80' : '#f87171';
                                const sign = diff >= 0 ? '+' : '';

                                return `
                                    <div style="background:#0f172a; padding:15px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                                        <div>
                                            <strong>${prop.name}</strong>
                                            <div style="font-size:0.85rem; color:#94a3b8; margin-top:5px;">
                                                <div>Compra: ${formatCurrency(purchasePrice)} | Actual: ${formatCurrency(prop.price)}</div>
                                                <div style="color:${color}; font-weight:bold;">Revalorizaci√≥n: ${sign}${pct}%</div>
                                                <div>Rentas: <span style="color:#4ade80">+${formatCurrency(prop.monthlyRent)}/mes</span></div>
                                            </div>
                                        </div>
                                        <button class="btn-sell-prop-dynamic" data-id="${prop.id}" style="background:#ef4444; color:white; border:none; padding:5px 15px; border-radius:4px; cursor:pointer;">Vender</button>
                                    </div>
                                `;
                            }).join('') +
                            '</div>'
                        }
                        </div>
                    </div>
                `;

                    // BIND EVENTS
                    container.querySelectorAll('.btn-buy-prop-dynamic').forEach(btn => {
                        btn.onclick = (e) => {
                            const id = parseInt(e.target.dataset.id);
                            const prop = REModule.availableProperties.find(p => p.id === id);
                            if (!prop) return;

                            UI.confirmModal('Comprar Propiedad', `¬øAdquirir ${prop.name}?\n\nPrecio: ${formatCurrency(prop.price)}\nEntrada (20%): ${formatCurrency(prop.price * 0.2)}\nEl resto se financiar√° con hipoteca.`, () => {
                                const res = REModule.buyProperty(id);
                                if (res.success) {
                                    UI.showModal('¬°Compra Exitosa!', res.message, [{ text: 'Genial', style: 'primary', fn: null }]);
                                    UI.updateHeader();
                                    UI.updateDashboard();
                                    UI.updateBank(Bank); // Update loans
                                    UI.updateRealEstate(REModule);
                                } else {
                                    UI.showModal('Error', res.message, [{ text: 'Cerrar', style: 'secondary', fn: null }]);
                                }
                            });
                        };
                    });

                    container.querySelectorAll('.btn-sell-prop-dynamic').forEach(btn => {
                        btn.onclick = (e) => {
                            const id = parseInt(e.target.dataset.id);
                            const prop = GameState.inventory.realEstate.find(p => p.id === id);
                            if (confirm(`¬øVender ${prop ? prop.name : 'propiedad'}?`)) {
                                const res = REModule.sellProperty(id);
                                alert(res.message);
                                if (res.success) {
                                    UI.updateHeader();
                                    UI.updateDashboard();
                                    UI.updateBank(Bank);
                                    UI.updateRealEstate(REModule);
                                }
                            }
                        };
                    });
                },

                openCompanyWizard() {
                    const modal = document.getElementById('company-wizard-modal');
                    const close = document.getElementById('close-wizard');
                    const step1 = document.getElementById('wizard-step-1');
                    const step2 = document.getElementById('wizard-step-2');

                    // Init Progress
                    const d1 = document.getElementById('step-dot-1');
                    const d2 = document.getElementById('step-dot-2');
                    d1.classList.add('active'); d1.textContent = '1';
                    d2.classList.remove('active'); d2.textContent = '2';

                    step1.classList.add('active');
                    step2.classList.remove('active');
                    document.getElementById('wiz-name').value = '';

                    let selectedType = null;
                    let selectedLoc = null;

                    const typeGrid = document.getElementById('wiz-types-grid');
                    typeGrid.innerHTML = '';
                    for (const [key, val] of Object.entries(CompanyModule.businessTypes)) {
                        const div = document.createElement('div');
                        div.className = 'wizard-option';
                        div.innerHTML = `
                        <div style="text-align:center; font-size:2rem; margin-bottom:10px;">üè¢</div>
                        <strong style="display:block; margin-bottom:5px;">${val.name}</strong>
                        <p style="font-size:0.8rem; color:#94a3b8">Inv. Inicial: <span style="color:white">${formatCurrency(val.cost)}</span></p>
                        <p style="font-size:0.75rem">Demanda Base: ${val.baseDemand}/mes</p>
                    `;
                        div.onclick = () => {
                            typeGrid.querySelectorAll('.wizard-option').forEach(el => el.classList.remove('selected'));
                            div.classList.add('selected');
                            selectedType = key;
                        };
                        typeGrid.appendChild(div);
                    }

                    const locGrid = document.getElementById('wiz-loc-grid');
                    locGrid.innerHTML = '';
                    for (const [key, val] of Object.entries(CompanyModule.locations)) {
                        const div = document.createElement('div');
                        div.className = 'wizard-option';
                        div.innerHTML = `
                         <div style="text-align:center; font-size:2rem; margin-bottom:10px;">üìç</div>
                         <strong style="display:block; margin-bottom:5px;">${val.name}</strong>
                         <p style="font-size:0.8rem">Alquiler: x${val.rentMult}</p>
                         <p style="font-size:0.8rem; color:#4ade80">Tr√°fico: x${val.trafficMult}</p>
                    `;
                        div.onclick = () => {
                            locGrid.querySelectorAll('.wizard-option').forEach(el => el.classList.remove('selected'));
                            div.classList.add('selected');
                            selectedLoc = key;
                            updateTotal();
                        };
                        locGrid.appendChild(div);
                    }

                    const updateTotal = () => {
                        if (selectedType) {
                            const cost = CompanyModule.businessTypes[selectedType].cost;
                            document.getElementById('wiz-total-cost').textContent = formatCurrency(cost);
                        }
                        document.getElementById('wiz-current-cash').textContent = formatCurrency(GameState.cash);
                    };

                    document.getElementById('btn-wiz-next-1').onclick = () => {
                        const name = document.getElementById('wiz-name').value;
                        if (!name) return alert('Ponle un nombre a tu empresa.');
                        if (!selectedType) return alert('Selecciona un tipo de negocio.');

                        step1.classList.remove('active');
                        step2.classList.add('active');

                        // Update Progress
                        document.getElementById('step-dot-1').textContent = '‚úì';
                        document.getElementById('step-dot-2').classList.add('active');

                        updateTotal();
                    };

                    document.getElementById('btn-wiz-back-2').onclick = () => {
                        step2.classList.remove('active');
                        step1.classList.add('active');

                        // Revert Progress
                        document.getElementById('step-dot-1').textContent = '1';
                        document.getElementById('step-dot-2').classList.remove('active');
                    };

                    document.getElementById('btn-wiz-finish').onclick = () => {
                        if (!selectedLoc) return alert('Selecciona una localizaci√≥n.');
                        const name = document.getElementById('wiz-name').value;

                        const res = CompanyModule.createCompany(name, selectedType, selectedLoc);
                        alert(res.message);
                        if (res.success) {
                            modal.style.display = 'none';
                            UI.updateHeader();
                            UI.updateJob(JobSystem);
                            UI.updateDashboard();
                        }
                    };

                    modal.style.display = 'block';
                    close.onclick = () => modal.style.display = 'none';
                    window.onclick = (e) => { if (e.target == modal) modal.style.display = 'none'; }
                },

                render() {
                    this.updateHeader();
                    this.updateDashboard();
                    // Only update active view
                    const activeViewId = document.querySelector('.view.active')?.id;
                    if (activeViewId === 'market-view') this.updateMarket();
                    else if (activeViewId === 'bank-view') this.updateBank(Bank);
                    else if (activeViewId === 'real-estate-view') this.updateRealEstate(RealEstate);
                    else if (activeViewId === 'job-view') this.updateJob(JobSystem);
                    else if (activeViewId === 'education-view') this.updateEducation(EducationModule);
                    // Dashboard is always updated by updateDashboard()
                },

                showView(targetView) {
                    document.querySelectorAll('.view').forEach(view => {
                        view.classList.remove('active');
                        if (view.id === `${targetView}-view`) {
                            view.classList.add('active');
                            if (targetView === 'market') UI.updateMarket();
                            if (targetView === 'bank') UI.updateBank(Bank);
                            if (targetView === 'real-estate') UI.updateRealEstate(RealEstate);
                            if (targetView === 'job') UI.updateJob(JobSystem);
                            if (targetView === 'education') UI.updateEducation(EducationModule);
                            if (targetView === 'dashboard') UI.updateDashboard();
                        }
                    });
                },

                updateEducation(EduModule) {
                    const container = document.getElementById('education-view');
                    if (!container) return;

                    // DATA
                    const courses = EduModule.courses;
                    const myEdu = GameState.education;
                    const current = GameState.currentCourse;

                    // HERO CONTENT
                    let heroHTML = '';
                    if (current) {
                        const progress = ((current.durationMonths - current.monthsLeft) / current.durationMonths) * 100;
                        heroHTML = `
                    <div class="edu-hero">
                        <div class="edu-icon">üìö</div>
                        <div class="edu-progress-container">
                            <h2 style="margin:0; font-size:1.5rem;">Estudiando: ${current.name}</h2>
                            <p style="color:#e2e8f0; margin:5px 0;">Tiempo Restante: ${current.monthsLeft} meses</p>
                            <div class="edu-bar-bg">
                                <div class="edu-bar-fill" style="width:${progress}%"></div>
                            </div>
                        </div>
                    </div>
                    `;
                    } else {
                        const highest = myEdu[myEdu.length - 1] || 'Sin Estudios';
                        heroHTML = `
                    <div class="edu-hero" style="background:linear-gradient(135deg, #3b82f6, #2563eb);">
                        <div class="edu-icon">üéì</div>
                        <div>
                            <h2 style="margin:0; font-size:1.5rem;">Formaci√≥n Actual</h2>
                            <p style="color:#e2e8f0; margin:5px 0;">M√°ximo Grado: <strong>${highest}</strong></p>
                            <p style="font-size:0.9rem; opacity:0.8;">Inscr√≠bete en un curso para mejorar tus perspectivas laborales.</p>
                        </div>
                    </div>
                    `;
                    }

                    // GRID CONTENT
                    const gridHTML = courses.map(course => {
                        const isCompleted = myEdu.includes(course.name);
                        const isStudying = current && current.id === course.id;
                        let actionBtn = '';
                        let statusBadge = '';

                        if (isCompleted) {
                            statusBadge = '<span style="background:rgba(245, 158, 11, 0.2); color:#f59e0b; padding:2px 8px; border-radius:4px; font-size:0.8rem; border:1px solid #f59e0b;">Completado</span>';
                        } else if (isStudying) {
                            statusBadge = '<span style="background:rgba(59, 130, 246, 0.2); color:#60a5fa; padding:2px 8px; border-radius:4px; font-size:0.8rem; border:1px solid #3b82f6;">En Curso</span>';
                        } else if (GameState.cash < course.cost) {
                            actionBtn = `<button class="btn-action-primary" disabled style="background:#334155; color:#94a3b8; cursor:not-allowed;">No hay fondos</button>`;
                        } else {
                            actionBtn = `<button class="btn-enroll-dynamic btn-action-primary" data-id="${course.id}">Matricularse</button>`;
                        }

                        return `
                    <div class="course-card-new ${isCompleted ? 'completed' : ''}">
                         <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span class="course-level">Nivel: ${course.level || 'B√°sico'}</span>
                            ${statusBadge}
                        </div>
                        <h3 style="margin:0 0 10px 0; color:#fff;">${course.name}</h3>
                        <div style="font-size:0.9rem; color:#94a3b8; margin-bottom:15px;">
                            <div>Duraci√≥n: ${course.durationMonths} meses</div>
                            <div>Coste: ${formatCurrency(course.costYear || 0)}</div>
                        </div>
                        ${!isCompleted && !isStudying ? actionBtn : ''}
                    </div>
                    `;
                    }).join('');

                    // RENDER
                    container.innerHTML = `
                    <div class="dashboard-container">
                        <div class="section-header">
                            <h2>Academia</h2>
                            <span style="color:#94a3b8; font-size:0.9rem;">T√≠tulos: ${myEdu.length}</span>
                        </div>
                        ${heroHTML}
                        
                        <h3 style="color:#cbd5e1; margin-bottom:20px;">Cat√°logo Formativo</h3>
                        <div class="course-grid">
                            ${gridHTML}
                        </div>
                    </div>
                `;

                    // EVENTS
                    container.querySelectorAll('.btn-enroll-dynamic').forEach(btn => {
                        btn.onclick = (e) => {
                            if (GameState.currentCourse) return alert("Ya est√°s estudiando un curso. Term√≠nalo antes de empezar otro.");
                            const id = e.target.dataset.id; // Corrected: IDs are strings
                            const course = EduModule.getCourse(id);
                            if (!course) return;

                            UI.confirmModal('Matriculaci√≥n', `¬øInscribirse en ${course.name}?\n\nDuraci√≥n: ${course.durationMonths} meses\nCoste: ${formatCurrency(course.costYear)}`, () => {
                                const res = EduModule.startCourse(id);
                                if (res.success) {
                                    UI.updateHeader();
                                    UI.updateDashboard();
                                    UI.updateEducation(EduModule);
                                    // Also update Job tab Goal card if needed
                                } else {
                                    alert(res.message);
                                }
                            });
                        };
                    });
                },

                showModal(title, msg, actions = []) {
                    const overlay = document.createElement('div');
                    overlay.className = 'custom-modal-overlay';
                    overlay.innerHTML = `
                    <div class="custom-modal-box">
                        <h3>${title}</h3>
                        <div class="modal-body">${msg.replace(/\n/g, '<br>')}</div>
                        <div class="modal-actions"></div>
                    </div>
                `;
                    const actionBox = overlay.querySelector('.modal-actions');
                    if (actions.length === 0) actions.push({ text: 'Entendido', style: 'primary', fn: null });

                    actions.forEach(a => {
                        const btn = document.createElement('button');
                        btn.textContent = a.text;
                        btn.className = `btn-modal btn-${a.style}-modal`;
                        btn.onclick = () => {
                            // Execute callback first (so inputs are still in DOM)
                            if (a.fn) {
                                // Optional: catch errors so modal still closes? 
                                // For now, let's just run it. If it fails, console will show it.
                                // But we should ensure close happens if possible, unless we want to keep it open on error?
                                // Simple approach: Run then Close.
                                try {
                                    a.fn();
                                } catch (e) {
                                    console.error("Modal Action Error:", e);
                                    alert("Error executing action: " + e.message);
                                }
                            }
                            overlay.remove();
                        };
                        actionBox.appendChild(btn);
                    });
                    document.body.appendChild(overlay);
                },

                confirmModal(title, msg, onConfirm) {
                    this.showModal(title, msg, [
                        { text: 'Cancelar', style: 'secondary', fn: null },
                        { text: 'Confirmar', style: 'danger', fn: onConfirm }
                    ]);
                },

                updateJob(JobSys) {
                    const jobContainer = document.getElementById('job-view');
                    if (!jobContainer) return;
                    jobContainer.innerHTML = '';
                    const contentContainer = document.createElement('div');

                    if (GameState.company) {
                        contentContainer.className = 'company-dashboard-full-view';
                        contentContainer.style.display = 'block';
                    } else {
                        contentContainer.className = 'dashboard-container';
                    }
                    jobContainer.appendChild(contentContainer);

                    // --- SHARED: HOLDING LIST (MANAGED COMPANIES) ---
                    // Always show if we own passive companies, regardless of active job/company
                    if (GameState.ownedCompanies && GameState.ownedCompanies.length > 0) {
                        const holdingSection = document.createElement('div');
                        holdingSection.className = 'dashboard-card full-width mb-30';
                        holdingSection.innerHTML = `<h3 style="color:#facc15; margin-bottom:15px; display:flex; align-items:center; gap:10px;">üëë Holding Empresarial</h3>`;
                        const holdingList = document.createElement('div');
                        holdingList.style.display = 'grid';
                        holdingList.style.gap = '10px';

                        GameState.ownedCompanies.forEach((co, idx) => {
                            const div = document.createElement('div');
                            div.className = 'holding-item-row';
                            div.innerHTML = `
                            <div class="holding-info">
                                <span class="co-name">${co.name}</span>
                                <span class="co-details">${co.typeName} | ${co.locationName}</span>
                            </div>
                            <div class="holding-stats">
                                <span class="co-profit">+${formatCurrency(co.baselineProfit)}/mes</span>
                                <button class="btn-sell-passive" data-idx="${idx}">VENDER</button>
                            </div>
                        `;
                            div.querySelector('.btn-sell-passive').onclick = () => {
                                UI.confirmModal('Vender Empresa', `¬øSeguro que quieres vender ${co.name}?\n\nValoraci√≥n: 5x Beneficio anual.`, () => {
                                    const res = CompanyModule.sellPassiveCompany(idx);
                                    if (res && res.success) {
                                        // Update UI
                                        UI.updateJob(JobSys);
                                        UI.updateDashboard();
                                        alert(res.message);
                                    }
                                });
                            };
                            holdingList.appendChild(div);
                        });
                        holdingSection.appendChild(holdingList);
                        contentContainer.appendChild(holdingSection);
                    }

                    if (!GameState.company) {
                        // --- PROFESSIONAL DASHBOARD MODE ---

                        // 2. Dashboard Top Grid (Hero + Goal)
                        const dashboardGrid = document.createElement('div');
                        dashboardGrid.className = 'dashboard-grid mb-30';

                        // --- CARD 1: CURRENT POSITION (HERO) ---
                        const heroCard = document.createElement('div');
                        heroCard.className = 'dashboard-card hero-card';

                        // Experience Progress Logic
                        const nextJob = JobSys.getAvailablePromotions();
                        let expPercent = 0;
                        let expText = "Nivel M√°ximo";
                        if (nextJob) {
                            expPercent = Math.min(100, (JobSys.monthsInCurrentJob / nextJob.reqMonths) * 100);
                            expText = `${JobSys.monthsInCurrentJob.toFixed(1)} / ${nextJob.reqMonths} meses`;
                        }

                        heroCard.innerHTML = `
                        <div class="card-header">
                            <span class="badge-primary">PUESTO ACTUAL</span>
                            <span class="salary-badge">${formatCurrency(GameState.salary)}/mes</span>
                        </div>
                        <h2 class="hero-title">${GameState.jobTitle}</h2>
                        <div class="career-path">Trayectoria: ${JobSys.currentCareerPath.toUpperCase()}</div>
                        
                        <div class="progress-section">
                            <div class="progress-label">
                                <span>Experiencia</span>
                                <span>${expText}</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill" style="width: ${expPercent}%"></div>
                            </div>
                        </div>
                    `;
                        dashboardGrid.appendChild(heroCard);

                        // --- CARD 2: NEXT GOAL (TARGET) ---
                        const goalCard = document.createElement('div');
                        goalCard.className = 'dashboard-card goal-card';

                        if (nextJob) {
                            const isEduOk = !nextJob.reqEdu || JobSys.checkEducation(nextJob.reqEdu);
                            const isExpOk = JobSys.monthsInCurrentJob >= nextJob.reqMonths;

                            goalCard.innerHTML = `
                            <div class="card-header">
                                <span class="badge-secondary">SIGUIENTE OBJETIVO</span>
                                <span class="salary-future">${formatCurrency(nextJob.salary)}</span>
                            </div>
                            <h3 class="goal-title">${nextJob.title}</h3>
                            
                            <div class="requirements-list">
                                <div class="req-item ${isExpOk ? 'req-met' : 'req-unmet'}">
                                    <span class="req-icon">${isExpOk ? '‚úÖ' : '‚è≥'}</span>
                                    <span>Experiencia: ${nextJob.reqMonths} meses</span>
                                </div>
                                <div class="req-item ${isEduOk ? 'req-met' : 'req-unmet'}">
                                    <span class="req-icon">${isEduOk ? '‚úÖ' : 'üìö'}</span>
                                    <span>Formaci√≥n: ${nextJob.reqEdu || 'Ninguna'}</span>
                                </div>
                            </div>

                            <button id="btn-promote-dashboard" class="btn-action-primary" ${isExpOk && isEduOk ? '' : 'disabled'}>
                                ${isExpOk && isEduOk ? 'SOLICITAR ASCENSO' : 'REQUISITOS PENDIENTES'}
                            </button>
                        `;

                            // Handler
                            const btn = goalCard.querySelector('#btn-promote-dashboard');
                            if (!btn.disabled) {
                                btn.onclick = () => {
                                    const res = JobSys.promote();
                                    if (res.success) {
                                        UI.showModal('¬°ENHORABUENA!', res.message, [{ text: 'Celebrar', style: 'success', fn: () => UI.updateJob(JobSys) }]);
                                    }
                                };
                            }

                        } else {
                            goalCard.innerHTML = `
                            <div class="card-header"><span class="badge-secondary">CIMA ALCANZADA</span></div>
                            <h3 class="goal-title">¬°Eres una leyenda!</h3>
                            <p style="color:#94a3b8; margin-top:10px;">Has llegado al m√°ximo nivel en esta profesi√≥n.</p>
                        `;
                        }
                        dashboardGrid.appendChild(goalCard);
                        contentContainer.appendChild(dashboardGrid);

                        // 3. Job Market (Grid)
                        const marketSection = document.createElement('div');
                        marketSection.className = 'market-section';
                        marketSection.innerHTML = `<h3 class="section-title">üåê Mercado Laboral</h3>`;

                        const marketGrid = document.createElement('div');
                        marketGrid.className = 'market-grid';

                        const vacancies = JobSys.getAllVacancies();
                        vacancies.forEach(vac => {
                            const card = document.createElement('div');
                            card.className = 'market-card';

                            const reqText = `${vac.reqMonths || 0}m Exp`;
                            const eduText = vac.reqEdu ? `${vac.reqEdu}` : null;

                            card.innerHTML = `
                            <div class="market-card-top">
                                <h4>${vac.title}</h4>
                                <span class="market-path">${vac.path}</span>
                            </div>
                            <div class="market-tags">
                                <span class="tag">${reqText}</span>
                                ${eduText ? `<span class="tag tag-edu">${eduText}</span>` : ''}
                            </div>
                            <div class="market-footer">
                                <div class="market-salary">${formatCurrency(vac.salary)}</div>
                                <button class="btn-apply-small">Aplicar</button>
                            </div>
                        `;

                            card.querySelector('.btn-apply-small').onclick = () => {
                                const res = JobSys.applyToJob(vac.title);
                                if (res.success) {
                                    UI.showModal('Nuevo Puesto', res.message, [{ text: 'Aceptar', style: 'success', fn: () => UI.updateJob(JobSys) }]);
                                } else {
                                    UI.showModal('Rechazado', res.message);
                                }
                            };
                            marketGrid.appendChild(card);
                        });
                        marketSection.appendChild(marketGrid);
                        contentContainer.appendChild(marketSection);

                        // 4. Entrepreneur Footer
                        const entrepreneurSection = document.createElement('div');
                        entrepreneurSection.className = 'entrepreneur-footer';
                        entrepreneurSection.innerHTML = `
                        <div class="entrepreneur-content">
                            <div class="entrepreneur-text">
                                <h3>üöÄ ¬øListo para dar el gran salto?</h3>
                                <p>Deja tu empleo y construye tu propio legado.</p>
                            </div>
                            <button id="btn-found-company" class="btn-entrepreneur">FUNDAR EMPRESA</button>
                        </div>
                    `;
                        entrepreneurSection.querySelector('#btn-found-company').onclick = () => UI.openCompanyWizard();
                        contentContainer.appendChild(entrepreneurSection);
                    } else {
                        // --- COMPANY OWNER MODE ---
                        const co = GameState.company;

                        // Persistent Tabs
                        const activeTab = jobContainer.dataset.activeTab || 'summary';

                        contentContainer.innerHTML = `
                        <div class="company-dashboard">
                            <div class="company-header">
                                <div>
                                    <h2>${co.name}</h2>
                                    <p>${co.typeName} | ${co.locationName}</p>
                                </div>
                                <div class="company-finance-summary">
                                    <div class="fin-box"><span class="label">Caja</span><span class="val">${formatCurrency(co.cash)}</span></div>
                                    <div class="fin-box"><span class="label">Beneficio Mes</span><span class="val ${co.profitLastMonth >= 0 ? 'green' : 'red'}">${formatCurrency(co.profitLastMonth)}</span></div>
                                    <button id="btn-automate" class="btn-gold" style="font-size:0.7rem;">Automatizar</button>
                                </div>
                            </div>

                            <div class="company-tabs">
                                <button class="tab-btn ${activeTab === 'summary' ? 'active' : ''}" data-tab="summary">Resumen</button>
                                <button class="tab-btn ${activeTab === 'staff' ? 'active' : ''}" data-tab="staff">Personal</button>
                                <button class="tab-btn ${activeTab === 'product' ? 'active' : ''}" data-tab="product">Producto</button>
                                <button class="tab-btn ${activeTab === 'marketing' ? 'active' : ''}" data-tab="marketing">Marketing</button>
                                <button class="tab-btn ${activeTab === 'finance' ? 'active' : ''}" data-tab="finance">Finanzas</button>
                            </div>

                            <div class="company-tab-content" id="co-tab-content">
                                <!-- Content injected here -->
                            </div>
                        </div>
                    `;

                        // Tab Switching Logic
                        contentContainer.querySelectorAll('.tab-btn').forEach(btn => {
                            btn.onclick = () => {
                                jobContainer.dataset.activeTab = btn.dataset.tab;
                                UI.updateJob(JobSys);
                            };
                        });

                        document.getElementById('btn-automate').onclick = () => {
                            const cost = Math.max(30000, (co.profitLastMonth || 0) * 3);
                            UI.confirmModal('Contratar Gerente', `Coste: ${formatCurrency(cost)}\n\n‚ö†Ô∏è Tu empresa pasar√° a ser PASIVA.\nPerder√°s el control manual.\n¬øDeseas automatizarla?`, () => {
                                const r = CompanyModule.hireManager();
                                if (r) {
                                    UI.showModal(r.success ? '¬°√âxito!' : 'Error', r.message, [
                                        {
                                            text: 'Aceptar', style: 'primary', fn: () => {
                                                if (r.success) { UI.updateJob(JobSys); UI.updateHeader(); UI.updateDashboard(); }
                                            }
                                        }
                                    ]);
                                }
                            });
                        };


                        const tabContent = document.getElementById('co-tab-content');

                        if (activeTab === 'summary') {
                            try {
                                let eventsHtml = co.events.map(e => `<li>${e}</li>`).join('');
                                if (!eventsHtml) eventsHtml = '<li style="color:#aaa">Sin novedades este mes.</li>';

                                // Safe access to history for percent diff
                                let revDiff = 0;
                                let expDiff = 0;
                                let profDiff = 0;

                                if (co.financialHistory && co.financialHistory.length >= 2) {
                                    const curr = co.financialHistory[co.financialHistory.length - 1];
                                    const prev = co.financialHistory[co.financialHistory.length - 2];

                                    if (curr && prev) {
                                        if (prev.revenue > 0) revDiff = (curr.revenue - prev.revenue) / prev.revenue;
                                    }
                                }

                                // Get latest expense details
                                let details = { wages: 0, rent: 0, cogs: 0, marketing: 0, opex: 0, salary: 0 };
                                let income = { revenue: co.revenueLastMonth }; // Add more income sources if/when available

                                if (co.financialHistory && co.financialHistory.length > 0) {
                                    const lastEntry = co.financialHistory[co.financialHistory.length - 1];
                                    if (lastEntry.expenses) {
                                        details = { ...details, ...lastEntry.expenses };
                                    }
                                }

                                const fmtDiff = (val) => {
                                    const s = val > 0 ? '+' : '';
                                    const color = val > 0 ? '#4ade80' : (val < 0 ? '#f87171' : '#94a3b8');
                                    return `<span style="color:${color}; font-size:0.8rem; margin-left:5px;">(${s}${(val * 100).toFixed(1)}%)</span>`;
                                };

                                tabContent.innerHTML = `
                                <div class="summary-grid">
                                    <div class="card kpi-card">
                                        <h3>Estado General</h3>
                                        <p>Reputaci√≥n: <strong>${co.reputation.toFixed(1)}/5.0</strong></p>
                                        <p>Clientes: ${co.lastStats ? co.lastStats.customers : 0} / mes</p>
                                        <div style="margin-top:10px; border-top:1px solid #334155; padding-top:5px;">
                                            <p>Ingresos: ${formatCurrency(co.revenueLastMonth)} ${fmtDiff(revDiff)}</p>
                                            <p>Gastos: ${formatCurrency(co.expensesLastMonth)} ${fmtDiff(expDiff)}</p>
                                            <p style="font-size:1.1rem; margin-top:5px;">Beneficio: <strong style="color:${co.profitLastMonth >= 0 ? 'var(--success-color)' : 'var(--danger-color)'}">${formatCurrency(co.profitLastMonth)}</strong> ${fmtDiff(profDiff)}</p>
                                        </div>
                                    </div>

                                    <div class="card events-card">
                                        <h3>üì¢ Novedades</h3>
                                        <ul style="max-height:150px; overflow-y:auto; padding-left:20px;">${eventsHtml}</ul>
                                    </div>
                                    
                                    <div class="card breakdown-card">
                                        <h3>üìã Desglose Financiero</h3>
                                        <table style="width:100%; font-size:0.85rem; border-collapse:collapse;">
                                            <tr style="border-bottom:1px solid #334155;">
                                                <td style="padding:4px 0;">Ventas</td>
                                                <td style="text-align:right; color:#4ade80;">+${formatCurrency(income.revenue)}</td>
                                            </tr>
                                            <tr><td style="padding:4px 0;">Coste Bienes (COGS)</td><td style="text-align:right;">-${formatCurrency(details.cogs)}</td></tr>
                                            <tr><td style="padding:4px 0;">Salarios Plantilla</td><td style="text-align:right;">-${formatCurrency(details.wages)}</td></tr>
                                            <tr><td style="padding:4px 0;">Alquiler</td><td style="text-align:right;">-${formatCurrency(details.rent)}</td></tr>
                                            <tr><td style="padding:4px 0;">Marketing</td><td style="text-align:right;">-${formatCurrency(details.marketing)}</td></tr>
                                            <tr><td style="padding:4px 0;">Operaciones (I+D)</td><td style="text-align:right;">-${formatCurrency(details.opex)}</td></tr>
                                            <tr style="border-bottom:1px solid #334155;"><td style="padding:4px 0;">Salario CEO</td><td style="text-align:right;">-${formatCurrency(details.salary)}</td></tr>
                                            <tr style="font-weight:bold;"><td style="padding-top:5px;">TOTAL GASTOS</td><td style="text-align:right; padding-top:5px;">-${formatCurrency(co.expensesLastMonth)}</td></tr>
                                        </table>
                                    </div>

                                    <div class="card chart-card">
                                        <h3>Evoluci√≥n Financiera</h3>
                                        <div style="height:200px; width:100%;">
                                            <canvas id="revenueChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            `;

                                // Render Chart
                                if (co.revenueHistory && co.revenueHistory.length > 0) {
                                    const ctx = document.getElementById('revenueChart').getContext('2d');

                                    // Slice last 12
                                    const labels = Array.from({ length: co.revenueHistory.length }, (_, i) => i + 1).slice(-12);
                                    const revData = co.revenueHistory.slice(-12);
                                    const profData = co.profitHistory.slice(-12);
                                    const expData = co.financialHistory ? co.financialHistory.slice(-12).map(h => h.expenses ? h.expenses.total : 0) : [];

                                    new Chart(ctx, {
                                        type: 'line',
                                        data: {
                                            labels: labels,
                                            datasets: [
                                                { label: 'Ingresos', data: revData, borderColor: '#4ade80', tension: 0.2, pointRadius: 2 },
                                                { label: 'Gastos', data: expData, borderColor: '#f87171', tension: 0.2, pointRadius: 2 },
                                                { label: 'Beneficio', data: profData, borderColor: '#38bdf8', tension: 0.2, pointRadius: 2 }
                                            ]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            plugins: { legend: { display: true, labels: { boxWidth: 10, font: { size: 10 } } } },
                                            scales: {
                                                y: { grid: { color: '#334155' }, ticks: { font: { size: 9 } } },
                                                x: { display: false }
                                            }
                                        }
                                    });
                                }
                            } catch (err) {
                                console.error("Summary Render Error", err);
                                tabContent.innerHTML = `<div class="error-box">ERROR RENDERING SUMMARY: ${err.message}</div>`;
                            }

                        } else if (activeTab === 'staff') {
                            let staffHtml = '';

                            // Calculate Office Cost
                            let upgradeCost = 0;
                            let upgradeText = "Ampliar Oficina";
                            let upgradeDisabled = "";

                            if (co.maxStaff === 5) upgradeCost = Math.max(15000, (co.profitLastMonth || 0) * 3);
                            else if (co.maxStaff === 10) upgradeCost = Math.max(30000, (co.profitLastMonth || 0) * 3);
                            else {
                                upgradeText = "M√°ximo Alcanzado";
                                upgradeDisabled = "disabled style='opacity:0.5; cursor:not-allowed;'";
                            }

                            if (!upgradeDisabled) {
                                upgradeText += ` (${formatCurrency(upgradeCost)})`;
                            }

                            co.staff.forEach((emp, i) => {
                                staffHtml += `
                                <div class="staff-row">
                                    <div>
                                        <strong>${emp.role}</strong><br>
                                        <span style="font-size:0.8rem">Habilidad: ${(emp.skill * 100).toFixed(0)}% | Moral: ${(emp.morale * 100).toFixed(0)}%</span>
                                    </div>
                                    <div style="text-align:right">
                                        <div>Salario: ${formatCurrency(emp.salary)} <span style="font-size:0.7rem; color:#94a3b8">(Req: ${formatCurrency(emp.requiredWage)})</span></div>
                                        <label style="font-size:0.7rem;"><input type="checkbox" ${emp.autoWage ? 'checked' : ''} onchange="toggleAutoWage(${i})"> Auto-subida</label>
                                    </div>
                                    <div style="text-align:right">
                                         <button onclick="fireEmployee(${i})" style="color:var(--danger-color); background:none; border:1px solid var(--danger-color); border-radius:4px; padding:2px 5px; cursor:pointer">Despedir</button>
                                    </div>
                                </div>
                            `;
                            });

                            tabContent.innerHTML = `
                            <div class="staff-section">
                                <div class="staff-header">
                                    <h3>Plantilla (${co.staff.length} / ${co.maxStaff})</h3>
                                    <button id="btn-upgrade-office" class="btn-sm" ${upgradeDisabled}>${upgradeText}</button>
                                </div>
                                <div class="staff-list">
                                    ${staffHtml || '<p>No hay empleados.</p>'}
                                </div>
                                <div class="hire-panel">
                                    <h4>Contratar</h4>
                                    <div style="display:flex; gap:5px;">
                                        <button onclick="hireRole('Dependiente', 1200)" class="btn-hire">Dependiente (1.2k)</button>
                                        <button onclick="hireRole('Experto', 1800)" class="btn-hire">Experto (1.8k)</button>
                                    </div>
                                </div>
                            </div>
                        `;

                            document.getElementById('btn-upgrade-office').onclick = () => {
                                const r = CompanyModule.upgradeOffice();
                                if (r) { alert(r.message); UI.updateJob(JobSystem); }
                            };

                            // Global handlers for inline onclicks (hacky but works for this structure)
                            window.hireRole = (role, sal) => {
                                const skill = role === 'Experto' ? 0.8 : 0.4;
                                const r = CompanyModule.hireStaff(role, sal, skill);
                                if (r) { if (!r.success) alert(r.message); UI.updateJob(JobSystem); }
                            };
                            window.fireEmployee = (i) => {
                                if (confirm('¬øDespedir empleado? Baja moral del equipo.')) {
                                    CompanyModule.fireStaff(i);
                                    UI.updateJob(JobSystem);
                                }
                            };
                            window.toggleAutoWage = (i) => {
                                if (GameState.company.staff[i]) GameState.company.staff[i].autoWage = !GameState.company.staff[i].autoWage;
                            }

                        } else if (activeTab === 'product') {
                            // PRODUCT TAB
                            const baseTicket = CompanyModule.businessTypes[co.typeId].baseTicket;
                            const currentPrice = co.customPrice || baseTicket;

                            // Calculate Equilibrium Price
                            const curProv = CompanyModule.providers[co.providerId];
                            const curActualQ = curProv.quality + ((co.productLevel - 1) * 0.05);
                            // Solve for Rep Change = 0 => TargetRep = CurrentRep
                            // TargetRep = 3.5 + (Gap * 5) => Gap = (CurrentRep - 3.5) / 5
                            const neededGap = (co.reputation - 3.5) / 5;
                            // Gap = Actual - Required => Required = Actual - Gap
                            const maxRequired = curActualQ - neededGap;
                            // Required = 0.7 + (Pct * 2) => Pct = (Required - 0.7) / 2
                            const allowedPct = (maxRequired - 0.7) / 2;
                            const equiPrice = baseTicket * (1 + allowedPct);

                            // Analysis
                            const stats = co.lastStats || { actualQuality: 0, requiredQuality: 0, targetRep: 3, repGrowth: 0 };
                            const qGap = stats.actualQuality - stats.requiredQuality;
                            const qColor = qGap >= 0 ? '#4ade80' : '#f87171';
                            const qText = qGap >= 0 ? 'Excelente (Sube Reputaci√≥n)' : 'Insuficiente (Baja Reputaci√≥n)';

                            let provOpts = '';
                            for (const [k, v] of Object.entries(CompanyModule.providers)) {
                                const isSel = co.providerId === k;
                                provOpts += `<div class="selection-card ${isSel ? 'selected' : ''}" onclick="setStrat('provider', '${k}')">
                                <strong>${v.name}</strong><br>Coste: x${v.priceMod}<br>Calidad: ${(v.quality * 100).toFixed(0)}%
                            </div>`;
                            }

                            tabContent.innerHTML = `
                            <div class="strategy-section">
                                <!-- Pricing & Analysis -->
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:25px;">
                                    <div class="card" style="padding:15px; border:1px solid #334155;">
                                        <h4>üè∑Ô∏è Estrategia de Precio</h4>
                                        <p style="font-size:0.85rem; color:#94a3b8; margin-bottom:5px;">Base Mercado: ${formatCurrency(baseTicket)}</p>
                                        <p style="font-size:0.85rem; color:#facc15; margin-bottom:10px;">Equilibrio (Rep. ${co.reputation.toFixed(1)}): <strong>${formatCurrency(equiPrice)}</strong></p>
                                        <div style="display:flex; align-items:center; gap:10px;">
                                            <input type="number" id="price-input" value="${currentPrice}" step="0.5" style="padding:5px; border-radius:4px; border:1px solid #475569; background:#0f172a; color:white; width:80px;">
                                            <button onclick="updatePrice()" class="btn-sm" style="background:var(--accent-color); color:black;">Fijar</button>
                                        </div>
                                    </div>
                                    <div class="card" style="padding:15px; border:1px solid ${qColor}; background:rgba(15, 23, 42, 0.5);">
                                        <h4>üìä An√°lisis de Reputaci√≥n</h4>
                                        <div style="font-size:0.8rem; margin-bottom:10px;">
                                            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #334155; padding-bottom:2px; margin-bottom:5px;">
                                                <span>Calidad Real:</span>
                                                <strong>${(stats.actualQuality * 100).toFixed(0)}%</strong>
                                            </div>
                                            <div style="color:#94a3b8; margin-bottom:5px; padding-left:10px;">
                                                ‚Ä¢ Base Proveedor: ${(curProv.quality * 100).toFixed(0)}%<br>
                                                ‚Ä¢ Bonus I+D (Nvl ${co.productLevel}): +${((co.productLevel - 1) * 5).toFixed(0)}%
                                            </div>

                                            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #334155; padding-bottom:2px; margin-bottom:5px;">
                                                <span>Exingencia (Precio):</span>
                                                <strong>${(stats.requiredQuality * 100).toFixed(0)}%</strong>
                                            </div>
                                            <div style="color:#94a3b8; margin-bottom:5px; padding-left:10px;">
                                                ‚Ä¢ Base Mercado: 70%<br>
                                                ‚Ä¢ Ajuste Precio: ${((stats.requiredQuality - 0.70) * 100).toFixed(0)}%
                                            </div>
                                        </div>
                                        <div style="text-align:center; padding-top:5px; border-top:1px solid #334155;">
                                            <p style="margin-bottom:0px;">Objetivo Reputaci√≥n: <strong>${stats.targetRep ? stats.targetRep.toFixed(2) : '3.50'}</strong></p>
                                            <p style="color:${qColor}; font-weight:bold; font-size:0.9rem; margin-top:2px;">${qText}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <h3 style="border-bottom:1px solid #334155; padding-bottom:5px; margin-bottom:15px;">üì¶ Proveedores (Insumos)</h3>
                                <div class="options-grid" style="margin-bottom:20px;">${provOpts}</div>

                                <h3 style="border-bottom:1px solid #334155; padding-bottom:5px; margin-bottom:15px;">üöÄ Desarrollo de Producto</h3>
                                <div class="invest-grid">
                                    <div class="invest-card">
                                        <h4>Producto (Nivel ${co.productLevel})</h4>
                                        <p>Mejora calidad (+5%) y satisfacci√≥n.</p>
                                        <button onclick="investCo('product_dev')">Invertir (${formatCurrency(co.productLevel * 5000)})</button>
                                    </div>
                                </div>
                            </div>
                        `;

                            // Handlers need to be re-attached or global
                            window.attachProductHandlers(); // Helper I will define

                        } else if (activeTab === 'marketing') {
                            // MARKETING TAB
                            const stats = co.lastStats || {};
                            const comp = stats.demandComposition || { base: 0, traffic: 1, marketing: 1, reputation: 1, organic: 1 };

                            let mktOpts = '';
                            for (const [k, v] of Object.entries(CompanyModule.marketingChannels)) {
                                const isSel = co.marketingChannel === k;
                                mktOpts += `<div class="selection-card ${isSel ? 'selected' : ''}" onclick="setStrat('marketing', '${k}')">
                                <strong>${v.name}</strong><br>Coste: ${formatCurrency(v.cost)}/mes<br>Impacto: x${v.impact}
                            </div>`;
                            }

                            tabContent.innerHTML = `
                            <div class="strategy-section">
                                <h3 style="border-bottom:1px solid #334155; padding-bottom:5px; margin-bottom:15px;">üì° Canales de Publicidad</h3>
                                <div class="options-grid" style="margin-bottom:20px;">${mktOpts}</div>

                                <div style="background:#1e293b; padding:15px; border-radius:8px; font-size:0.9rem; margin-bottom:20px; border:1px dashed #334155;">
                                    <h4 style="margin-top:0; color:#38bdf8;">üìà An√°lisis de Demanda</h4>
                                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                        <div>Base: <strong>${comp.base}</strong></div>
                                        <div>Tr√°fico: <strong>x${comp.traffic.toFixed(2)}</strong></div>
                                        <div>Marketing: <strong>x${comp.marketing.toFixed(2)}</strong></div>
                                        <div>Reputaci√≥n: <strong>x${comp.reputation.toFixed(2)}</strong></div>
                                        <div>Org√°nico: <strong>x${comp.organic.toFixed(2)}</strong></div>
                                        <div style="color:#facc15;">Volatilidad (Azar): <strong>x${(comp.volatility || 1).toFixed(2)}</strong></div>
                                        <div style="grid-column: 1 / -1; border-top:1px solid #334155; margin-top:5px; padding-top:5px;">
                                            Total Estimado: <strong style="color:var(--success-color);">${stats.demand || 0} clientes/mes</strong>
                                        </div>
                                    </div>
                                </div>

                                <h3 style="border-bottom:1px solid #334155; padding-bottom:5px; margin-bottom:15px;">üöÄ Infraestructura de Marketing</h3>
                                <div class="invest-grid">
                                    <div class="invest-card">
                                        <h4>Marketing (Nivel ${co.marketingLevel})</h4>
                                        <p>Potencia eficacia (+20%) de campa√±as.</p>
                                        <button onclick="investCo('marketing_infra')">Invertir (${formatCurrency(co.marketingLevel * 5000)})</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        }

                        // Re-attach global handlers just in case (doing it outside blocks is cleaner)
                        window.setStrat = (cat, val) => {
                            CompanyModule.setStrategicOption(cat, val);
                            UI.updateJob(JobSystem);
                        };
                        window.investCo = (type) => {
                            const r = CompanyModule.invest(type);
                            if (r) { alert(r.message); UI.updateJob(JobSystem); }
                        }
                        window.updatePrice = () => {
                            const val = parseFloat(document.getElementById('price-input').value);
                            if (val > 0) {
                                GameState.company.customPrice = val;
                                alert(`Precio fijado en ${formatCurrency(val)}. La exigencia de calidad cambiar√°.`);
                                UI.updateJob(JobSystem);
                            }
                        }
                        window.attachProductHandlers = () => { }; // Placeholder if needed

                        if (activeTab === 'finance') {
                            tabContent.innerHTML = `
                            <div class="finance-actions">
                                <h3>Movimientos de Caja</h3>
                                <div class="control-group">
                                    <label>Retirar Fondos a Cuenta Personal</label>
                                    <div style="display:flex; gap:10px;">
                                        <input type="number" id="co-trans-amount" placeholder="Cantidad" style="width:150px;">
                                        <button id="btn-withdraw">Retirar</button>
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label>Inyectar Capital Personal</label>
                                    <div style="display:flex; gap:10px;">
                                        <input type="number" id="co-dep-amount" placeholder="Cantidad" style="width:150px;">
                                        <button id="btn-deposit">Ingresar</button>
                                    </div>
                                </div>

                                <h3 style="margin-top:20px;">Salario del CEO</h3>
                                <div class="control-group">
                                    <p>Tu sueldo mensual (Cubre tus gastos personales)</p>
                                    <div style="display:flex; gap:10px;">
                                        <input type="number" id="co-ceo-salary" value="${co.ceoSalary || 0}" style="width:150px;">
                                        <button id="btn-set-salary">Actualizar</button>
                                    </div>
                                </div>

                                <h3 style="margin-top:20px; color:var(--danger-color)">Zona de Peligro</h3>
                                <button onclick="sellCompanyAction()" style="background:var(--danger-color); color:white; border:none; padding:10px; width:100%;">VENDER EMPRESA (EXIT)</button>
                            </div>
                         `;

                            document.getElementById('btn-withdraw').onclick = () => {
                                const val = parseInt(document.getElementById('co-trans-amount').value);
                                if (!val || val <= 0) return alert('Introduce cantidad v√°lida');
                                let r = CompanyModule.withdraw(val);
                                if (r) alert(r.message);
                                UI.updateJob(JobSystem);
                                UI.updateHeader();
                            };
                            document.getElementById('btn-deposit').onclick = () => {
                                const val = parseInt(document.getElementById('co-dep-amount').value);
                                if (!val || val <= 0) return alert('Introduce cantidad v√°lida');
                                let r = CompanyModule.deposit(val);
                                if (r) alert(r.message);
                                UI.updateJob(JobSystem);
                                UI.updateHeader();
                            };
                            document.getElementById('btn-set-salary').onclick = () => {
                                const val = parseInt(document.getElementById('co-ceo-salary').value) || 0;
                                co.ceoSalary = val;
                                alert(`Salario de CEO actualizado a ${formatCurrency(val)}`);
                                UI.updateJob(JobSystem);
                            };
                            window.sellCompanyAction = () => {
                                const r = CompanyModule.sellCompany();
                                if (r && r.success) {
                                    alert(r.message);
                                    UI.updateHeader();
                                    UI.updateJob(JobSystem);
                                    UI.updateDashboard();
                                }
                            };
                        }
                    }
                }
            };
            function nextTurn() {
                StockMarket.nextTurn();
                RealEstate.nextTurn(); // Dynamic prices
                Bank.nextTurn();
                JobSystem.nextTurn();
                EducationModule.nextTurn(); // Study progress
                CompanyModule.nextTurn(); // Company Progress

                const rentIncome = GameState.inventory.realEstate.reduce((acc, p) => acc + p.monthlyRent, 0);
                const netIncome = GameState.salary + rentIncome - GameState.expenses;
                GameState.cash += netIncome;
                GameState.month++;
                if (GameState.month > 12) {
                    GameState.month = 1;
                    GameState.year++;
                    GameState.age++; // Birthday!
                }
                if (GameState.month % 6 === 0) {
                    RealEstate.generateListings();
                }

                // History & Chart
                const nw = updateNetWorth();
                let totalDebt = 0;
                GameState.loans.forEach(l => totalDebt += l.remainingBalance);
                let assetsOnly = nw + totalDebt; // Roughly

                GameState.history.netWorth.push(nw);
                GameState.history.cash.push(GameState.cash);
                GameState.history.debt.push(totalDebt);
                GameState.history.assets.push(assetsOnly);
                GameState.history.labels.push(`${GameState.month}/${GameState.year}`);

                // Max 24 points to keep it clean? Or scrollable. Canvas resizes fine. 
                // If dragging too long, slice.
                if (GameState.history.netWorth.length > 50) {
                    GameState.history.netWorth.shift();
                    GameState.history.cash.shift();
                    GameState.history.debt.shift();
                    GameState.history.assets.shift();
                    GameState.history.labels.shift();
                }

                UI.render();
            }


            function setupEventListeners() {
                // 1. Navigation Listeners (PRIORITY)
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetView = btn.dataset.view;
                        if (!targetView) return;

                        // Update desktop nav active state
                        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        // Update bottom nav active state
                        document.querySelectorAll('.b-nav-item').forEach(b => {
                            b.classList.remove('active');
                            if (b.dataset.view === targetView) b.classList.add('active');
                        });

                        UI.showView(targetView);
                    });
                });

                // 2. Next Turn
                const nextBtn = document.getElementById('next-turn-btn');
                if (nextBtn) {
                    // Remove old listeners to be safe? (Clone)
                    const newBtn = nextBtn.cloneNode(true);
                    nextBtn.parentNode.replaceChild(newBtn, nextBtn);
                    newBtn.addEventListener('click', nextTurn);
                }

                // 3. Obsolete Static Listeners Clean-up
                // Since we moved to dynamic rendering for Bank, Real Estate, etc.
                // we do NOT attach static listeners here anymore.
                // They are re-attached inside UI.updateBank(), UI.updateRealEstate(), etc.
                console.log('Event Listeners Initialized');
            }

            // INIT
            function injectCustomStyles() {
                const style = document.createElement('style');
                style.textContent = `
                .custom-modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:9999; backdrop-filter:blur(4px); animation: fadeIn 0.2s; }
                .custom-modal-box { background:#1e293b; padding:25px; border-radius:12px; max-width:450px; width:90%; border:1px solid #475569; box-shadow:0 20px 50px rgba(0,0,0,0.5); transform:scale(0.95); animation: popUp 0.2s forwards; }
                .custom-modal-box h3 { margin-top:0; color:#facc15; font-size:1.3rem; margin-bottom:15px; border-bottom:1px solid #334155; padding-bottom:10px; }
                .modal-body { color:#cbd5e1; font-size:0.95rem; line-height:1.5; margin-bottom:25px; }
                .modal-actions { display:flex; justify-content:flex-end; gap:12px; }
                .btn-modal { padding:8px 16px; border-radius:6px; font-weight:bold; cursor:pointer; border:none; transition:transform 0.1s; }
                .btn-modal:active { transform:scale(0.95); }
                .btn-primary-modal { background:var(--accent-color); color:#0f172a; }
                .btn-danger-modal { background:#ef4444; color:white; }
                .btn-secondary-modal { background:#475569; color:#e2e8f0; }
                
                @keyframes fadeIn { from {opacity:0} to {opacity:1} }
                @keyframes popUp { from {transform:scale(0.95); opacity:0} to {transform:scale(1); opacity:1} }
                
                .job-section-spacer { margin-bottom: 30px; border-bottom: 1px solid #1e293b; padding-bottom: 20px; }
                .job-req-tag { background:#0f172a; color:#94a3b8; padding:3px 8px; border-radius:4px; font-size:0.75rem; border:1px solid #334155; display:inline-block; margin-top:5px; }
                
                /* DASHBOARD STYLES (NEW) */
                .dashboard-container { max-width: 1200px; margin: 0 auto; color: #fff; }
                .mb-30 { margin-bottom: 30px; }
                
                /* Grids */
                .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
                .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }

                .btn-filter { background:none; border:none; color:#64748b; font-size:0.8rem; cursor:pointer; font-weight:bold; padding:2px 5px; }
                .btn-filter:hover { color:#94a3b8; }
                .btn-filter.active { color:#facc15; border-bottom:2px solid #facc15; }
                
                @media(max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } }

                /* Cards */
                .dashboard-card { background: rgba(30, 41, 59, 0.7); border: 1px solid #334155; border-radius: 12px; padding: 25px; backdrop-filter: blur(5px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                .hero-card { background: linear-gradient(145deg, #0f172a, #1e293b); border-left: 4px solid #38bdf8; }
                .goal-card { background: rgba(15, 23, 42, 0.8); border: 1px dashed #475569; display: flex; flex-direction: column; justify-content: space-between; }
                
                /* Hero Typography */
                .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; }
                .hero-title { font-size: 2rem; margin: 0 0 5px 0; background: linear-gradient(90deg, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
                .career-path { color: #38bdf8; font-size: 0.9rem; margin-bottom: 25px; }
                .salary-badge { color: #4ade80; font-weight: bold; background: rgba(74, 222, 128, 0.1); padding: 4px 8px; border-radius: 4px; }
                
                /* Progress Bar */
                .progress-section { margin-top: 15px; }
                .progress-label { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; color: #cbd5e1; }
                .progress-track { height: 8px; background: #334155; border-radius: 4px; overflow: hidden; }
                .progress-fill { height: 100%; background: #38bdf8; transition: width 0.5s ease; }

                /* Goal Card */
                .goal-title { font-size: 1.5rem; margin: 0 0 20px 0; color: #fff; }
                .requirements-list { margin-bottom: 15px; }
                .req-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #1e293b; font-size: 0.95rem; }
                .req-item:last-child { border-bottom: none; }
                .req-met { color: #94a3b8; }
                .req-unmet { color: #f87171; } /* Warning color for unmet */
                .req-met .req-icon { filter: grayscale(0); }
                
                /* Action Buttons */
                .btn-action-primary { width: 100%; padding: 12px; background: #38bdf8; color: #0f172a; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.2s; margin-top: 15px; }
                .btn-action-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3); }
                .btn-action-primary:disabled { background: #334155; color: #64748b; cursor: not-allowed; }

                /* Market Section */
                .section-title { margin: 10px 0 20px 0; font-size: 1.3rem; border-bottom: 2px solid #334155; padding-bottom: 10px; display: inline-block; }
                .market-card { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; height: 100%; transition: border-color 0.2s; }
                .market-card:hover { border-color: #38bdf8; }
                .market-card-top h4 { margin: 0 0 5px 0; font-size: 1.1rem; }
                .market-path { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; }
                .market-tags { display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; }
                .tag { font-size: 0.75rem; background: #0f172a; color: #cbd5e1; padding: 2px 6px; border-radius: 4px; border: 1px solid #334155; }
                .tag-edu { border-color: #d97706; color: #fbbf24; }
                .market-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
                .market-salary { font-weight: bold; color: #4ade80; }
                .btn-apply-small { padding: 6px 15px; background: transparent; border: 1px solid #38bdf8; color: #38bdf8; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
                .btn-apply-small:hover { background: #38bdf8; color: #0f172a; }

                /* Entrepreneur Footer */
                .entrepreneur-footer { margin-top: 40px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid #d97706; border-radius: 12px; padding: 30px; position: relative; overflow: hidden; }
                .entrepreneur-footer::before { content: 'üëë'; position: absolute; font-size: 10rem; opacity: 0.05; right: -20px; top: -40px; transform: rotate(15deg); }
                .entrepreneur-content { display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1; }
                .entrepreneur-text h3 { margin: 0 0 5px 0; color: #f59e0b; font-size: 1.5rem; }
                .entrepreneur-text p { margin: 0; color: #cbd5e1; }
                .btn-entrepreneur { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); transition: transform 0.2s; }
                .btn-entrepreneur:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5); }
                
                @media(max-width: 600px) { .entrepreneur-content { flex-direction: column; text-align: center; gap: 20px; } }
                
                /* Create Company Wizard Styles */
                .create-company-btn { background: linear-gradient(135deg, #f59e0b, #d97706); color: #fff; font-weight: 800; font-size: 1.1rem; padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px; }
                .create-company-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5); }
                .create-company-card { background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid #d97706; text-align: center; padding: 30px; border-radius: 16px; margin-top: 40px; }

                /* --- GLOBAL DASHBOARD REDESIGN STYLES --- */
                
                /* Shared Utilities */
                .section-header { margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
                .section-header h2 { margin: 0; font-size: 1.5rem; color: #fff; background: linear-gradient(90deg, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
                
                /* BANK TAB */
                .bank-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
                @media(max-width: 768px) { .bank-grid { grid-template-columns: 1fr; } }
                .calculator-card { background: rgba(30, 41, 59, 0.6); border: 1px solid #334155; padding: 20px; border-radius: 12px; }
                .loan-input-group { margin-bottom: 15px; }
                .loan-input-group label { display: block; color: #94a3b8; font-size: 0.85rem; margin-bottom: 5px; }
                .loan-input { width: 100%; background: #0f172a; border: 1px solid #475569; padding: 10px; color: white; border-radius: 6px; font-size: 1rem; }
                .loan-summary { background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid #334155; margin-top: 20px; }
                .active-loan-card { background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid #ef4444; border-radius: 8px; padding: 15px; margin-bottom: 15px; position: relative; overflow: hidden; }
                .active-loan-card::before { content: 'üí∏'; position: absolute; right: -10px; top: -10px; font-size: 5rem; opacity: 0.05; transform: rotate(15deg); }
                .loan-progress { height: 6px; background: #334155; border-radius: 3px; margin: 10px 0; overflow: hidden; }
                .loan-bar { height: 100%; background: #ef4444; width: 0%; transition: width 0.5s; }

                /* REAL ESTATE TAB */
                .portfolio-hero { background: linear-gradient(135deg, #059669, #065f46); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 4px 15px rgba(5, 150, 105, 0.2); }
                .portfolio-stat { text-align: center; }
                .portfolio-stat .label { display: block; font-size: 0.8rem; opacity: 0.8; text-transform: uppercase; }
                .portfolio-stat .value { font-size: 1.5rem; font-weight: bold; }
                
                .property-card-expert { background: #1e293b; border: 1px solid #334155; border-radius: 8px; overflow: hidden; transition: transform 0.2s; display: flex; flex-direction: column; }
                .property-card-expert:hover { transform: translateY(-3px); border-color: #38bdf8; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
                .prop-img { height: 120px; background: #0f172a; display: flex; justify-content: center; align-items: center; font-size: 3rem; position: relative; }
                .deal-badge { position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
                .good-deal { background: #059669; color: white; }
                .bad-deal { background: #ef4444; color: white; }
                .prop-content { padding: 15px; flex: 1; display: flex; flex-direction: column; }
                .prop-price-large { font-size: 1.3rem; color: #fff; font-weight: bold; margin: 5px 0; }
                .prop-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.8rem; color: #94a3b8; margin: 10px 0; }
                .prop-roi { color: #4ade80; font-weight: bold; }

                /* MARKET TAB (Trading Terminal) */
                .market-hero { background: #0f172a; border-bottom: 1px solid #334155; padding: 20px; margin-bottom: 20px; border-radius: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
                .stock-chip { background: #1e293b; border: 1px solid #334155; padding: 12px; border-radius: 6px; cursor: pointer; transition: all 0.1s; display: flex; justify-content: space-between; align-items: center; }
                .stock-chip:hover { background: #334155; border-color: #38bdf8; }
                .stock-chip.falling { border-left: 3px solid #ef4444; }
                .stock-chip.rising { border-left: 3px solid #4ade80; }
                
                /* EDUCATION TAB */
                .edu-hero { background: linear-gradient(135deg, #4f46e5, #4338ca); color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; display: flex; align-items: center; gap: 20px; }
                .edu-icon { font-size: 3rem; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 50%; }
                .edu-progress-container { flex: 1; }
                .edu-bar-bg { background: rgba(0,0,0,0.3); height: 10px; border-radius: 5px; margin-top: 10px; overflow: hidden; }
                .edu-bar-fill { height: 100%; background: #fbbf24; width: 0%; transition: width 0.5s; box-shadow: 0 0 10px #fbbf24; }
                
                .course-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
                .course-card-new { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 20px; position: relative; }
                .course-card-new.completed { border-color: #f59e0b; opacity: 0.7; }
                .course-card-new.completed::after { content: '‚úì'; position: absolute; top: 10px; right: 10px; color: #f59e0b; font-size: 1.5rem; }
                .course-level { font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; letter-spacing: 1px; }

                /* SUMMARY (DASHBOARD) TAB */
                .summary-kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
                .kpi-box { background: linear-gradient(145deg, #1e293b, #0f172a); padding: 20px; border-radius: 10px; border: 1px solid #334155; text-align: center; }
                .kpi-label { color: #94a3b8; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 5px; }
                .kpi-value { font-size: 1.8rem; font-weight: bold; color: #fff; }
                .kpi-sub { font-size: 0.8rem; color: #64748b; }

                /* MOBILE OPTIMIZATIONS */
                #bottom-nav { display: none; } /* Hidden by default */
                
                @media(max-width: 768px) {
                    /* Header Adjustments */
                    .app-header { display: flex !important; flex-direction: column; gap: 10px; padding: 15px !important; }
                    .header-left, .header-center, .header-right { width: 100%; justify-content: space-between !important; }
                    .header-center { order: 3; margin-top: 5px; } /* Next button at bottom of header pile */
                    #next-turn-btn { width: 100%; padding: 12px; font-size: 1.1rem; }

                    /* Navigation Switch */
                    .desktop-nav { display: none !important; }
                    #bottom-nav { 
                        display: grid; 
                        grid-template-columns: repeat(6, 1fr); 
                        position: fixed; 
                        bottom: 0; left: 0; width: 100%; 
                        background: rgba(15, 23, 42, 0.95); 
                        backdrop-filter: blur(10px); 
                        border-top: 1px solid #334155; 
                        z-index: 1000; 
                        padding-bottom: env(safe-area-inset-bottom);
                    }
                    .b-nav-item { 
                        background: none; border: none; 
                        color: #94a3b8; 
                        padding: 10px 0; 
                        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
                        font-size: 0.7rem; 
                    }
                    .b-nav-item.active { color: #38bdf8; }
                    .b-nav-item .icon { font-size: 1.2rem; }

                    /* View Container Padding for Bottom Nav */
                    #view-container { margin-bottom: 80px; }

                    /* Layout Stacks */
                    .dashboard-grid, .bank-grid, .stats-grid, .market-hero, .prop-details-grid, .summary-kpi-row { grid-template-columns: 1fr !important; }
                    .hero-card, .market-card, .property-card-expert, .course-card-new, .dashboard-card, .kpi-box { margin-bottom: 10px; }
                    
                    /* Dashboard Compact */
                    .dashboard-card { padding: 15px !important; }
                    .kpi-box { padding: 15px !important; display: flex; justify-content: space-between; align-items: center; text-align: left; }
                    .kpi-value { font-size: 1.4rem !important; }
                    .kpi-label { font-size: 0.75rem !important; margin: 0; }
                    
                    /* Typography sizes */
                    h1 { font-size: 1.2rem !important; }
                    h2 { font-size: 1.3rem !important; }
                    
                    /* Modals */
                    .modal-content { width: 95% !important; margin: 20px auto !important; max-height: 85vh; overflow-y: auto; }
                }
            `;
                document.head.appendChild(style);
            }

            try {
                console.log('Juego iniciado');
                injectCustomStyles();

                const initGame = () => {
                    StockMarket.init();
                    UI.render();
                    setupEventListeners();

                    // Sync Bottom Nav
                    document.querySelectorAll('.b-nav-item').forEach(btn => {
                        btn.onclick = () => {
                            // Update Active State Visuals
                            document.querySelectorAll('.b-nav-item').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');

                            // Trigger Logic
                            const view = btn.dataset.view;
                            UI.showView(view); // Reuse existing method

                            // Sync Desktop Nav state just in case
                            document.querySelectorAll('.nav-btn').forEach(b => {
                                b.classList.remove('active');
                                if (b.dataset.view === view) b.classList.add('active');
                            });
                        };
                    });

                    // Sync Desktop Nav to Bottom Nav
                    document.getElementById('main-nav').querySelectorAll('.nav-btn').forEach(btn => {
                        const originalClick = btn.onclick; // Preserving if any (though usually handled by event delegation or loop below)
                        btn.onclick = () => {
                            const view = btn.dataset.view;
                            UI.showView(view);

                            // Sync Bottom Nav
                            document.querySelectorAll('.b-nav-item').forEach(b => {
                                b.classList.remove('active');
                                if (b.dataset.view === view) b.classList.add('active');
                            });
                        }
                    });

                    // Hack to force initial job display update and ChartTick
                    setTimeout(() => {
                        try {
                            UI.updateJob(JobSystem);
                            UI.updateDashboard();
                        } catch (e) {
                            console.error('Async Init Error:', e);
                        }
                    }, 100);
                };

                // STARTUP LOGIC
                if (PersistenceModule.checkSave()) {
                    const savedState = JSON.parse(localStorage.getItem(PersistenceModule.SAVE_KEY));
                    const msg = `
                    <div style="text-align:center; padding:20px;">
                        <div style="font-size:3rem;">üíæ</div>
                        <h3>Partida Encontrada</h3>
                        <p style="color:#cbd5e1; margin-bottom:20px;">
                            Jugador: <strong>${savedState.playerName || 'Desconocido'}</strong><br>
                            Dinero: ${formatCurrency(savedState.cash)}<br>
                            A√±o: ${savedState.year} | Mes: ${savedState.month}
                        </p>
                    </div>
                 `;

                    UI.showModal('Bienvenido de nuevo', msg, [
                        {
                            text: 'Continuar Partida', style: 'success', fn: () => {
                                PersistenceModule.loadGame();
                                initGame();
                            }
                        },
                        {
                            text: 'Nueva Partida', style: 'secondary', fn: () => {
                                if (confirm("¬øSeguro? Se borrar√° el progreso actual (aunque la partida anterior sigue en memoria hasta que guardes la nueva).")) {
                                    localStorage.removeItem(PersistenceModule.SAVE_KEY);
                                    promptNewUser(initGame);
                                }
                            }
                        }
                    ]);
                } else {
                    promptNewUser(initGame);
                }

                function promptNewUser(callback) {
                    const msg = `
                    <div style="text-align:center;">
                        <p>Bienvenido al simulador de inversi√≥n definitivo.</p>
                        <div style="margin:20px 0;">
                            <label style="display:block; text-align:left; color:#94a3b8; font-size:0.8rem; margin-bottom:5px;">Nombre de Usuario</label>
                            <input type="text" id="start-player-name" placeholder="Tu Nombre" style="width:100%; padding:12px; background:#1e293b; border:1px solid #475569; color:white; border-radius:6px; font-size:1.1rem;">
                        </div>
                    </div>
                 `;

                    UI.showModal('Crear Perfil', msg, [
                        {
                            text: 'Empezar Aventura', style: 'success', fn: () => {
                                const name = document.getElementById('start-player-name').value;
                                if (name && name.trim().length > 0) {
                                    GameState.playerName = name.trim();
                                    callback();
                                } else {
                                    alert("Por favor, introduce un nombre.");
                                    // Re-open modal hack (simple recursion)
                                    setTimeout(() => promptNewUser(callback), 100);
                                }
                            }
                        }
                    ]);
                }

            } catch (e) {
                alert('CRITICAL ERROR STARTING GAME: ' + e.message + '\n' + e.stack);
                console.error(e);
            }

        </script>
</body>

</html>